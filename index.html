
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>귀멸의 칼날: 귀살대 키우기 (Ver 16.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap');
      
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #020617;
        color: #e2e8f0;
        margin: 0;
        overflow: hidden;
        touch-action: manipulation;
        overscroll-behavior: none;
      }
      .font-cinzel {
        font-family: 'Cinzel', serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #0f172a; 
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #475569; 
      }
      @keyframes bounce-up {
          0% { transform: translateY(20px) scale(0.8); opacity: 0; }
          20% { transform: translateY(0) scale(1.1); opacity: 1; }
          80% { transform: translateY(-20px) scale(1); opacity: 1; }
          100% { transform: translateY(-50px) scale(0.9); opacity: 0; }
      }
      .animate-bounce-up {
          animation: bounce-up 1.5s ease-out forwards;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
      }
      .animate-shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
      @keyframes aura-legendary {
        0% { box-shadow: 0 0 10px #a855f7; }
        50% { box-shadow: 0 0 25px #d8b4fe, 0 0 10px #a855f7 inset; }
        100% { box-shadow: 0 0 10px #a855f7; }
      }
      .aura-limit-break {
        animation: aura-legendary 3s infinite;
        border: 2px solid #a855f7;
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Swords, Home, ShoppingBag, Heart, Skull, Zap, ChevronRight, CheckCircle2, Circle, Users, ShieldAlert, Sparkles, Flame, Hammer, Mountain, Gem, Backpack, Flower, Target, BarChart2, Dumbbell, PlayCircle, PauseCircle, Crown, Shield, Droplets, BookOpen } from 'lucide-react';

      // --- CONSTANTS & DATA ---
      
      const BreathingStyle = {
        WATER: '물의 호흡', THUNDER: '번개의 호흡', BEAST: '짐승의 호흡', FLAME: '화염의 호흡',
        MIST: '안개의 호흡', INSECT: '벌레의 호흡', STONE: '바위의 호흡', WIND: '바람의 호흡',
        SOUND: '소리의 호흡', LOVE: '사랑의 호흡', SERPENT: '뱀의 호흡', SUN: '해의 호흡',
        MOON: '달의 호흡', ICE: '얼음의 호흡 (혈귀술)', FLOWER: '꽃의 호흡', BLOOD: '혈귀술',
        NONE: '호흡 없음 (무술/특수)', ARROW: '화살표 혈귀술', TEMARI: '공 혈귀술', THREAD: '실 혈귀술', DREAM: '꿈 혈귀술'
      };

      const Role = { ATTACKER: 'ATTACKER', SUPPORTER: 'SUPPORTER' };

      const RANKS = [
        { id: 0, name: '계급: 계 (Mizunoto)', minLv: 1, multiplier: 1.0, cost: 0 },
        { id: 1, name: '계급: 경 (Kanoe)', minLv: 10, multiplier: 1.5, cost: 2000 },
        { id: 2, name: '계급: 병 (Hinoe)', minLv: 30, multiplier: 2.5, cost: 10000 },
        { id: 3, name: '계급: 갑 (Kinoe)', minLv: 50, multiplier: 4.0, cost: 50000 },
        { id: 4, name: '주 (Hashira)', minLv: 80, multiplier: 7.0, cost: 200000 },
        { id: 5, name: '계승자 (Tsuguko)', minLv: 100, multiplier: 10.0, cost: 1000000 },
        { id: 6, name: '지주 대리 (Acting Hashira)', minLv: 150, multiplier: 15.0, cost: 5000000 },
        { id: 7, name: '최강의 검사 (Legend)', minLv: 200, multiplier: 25.0, cost: 20000000 }
      ];

      const TRAINING_TYPES = [
        { id: 'muscle', name: '기초 체력 단련', desc: '모든 대원의 체력 +5%', costBase: 1000, costScale: 1.5, stat: 'maxHp', val: 0.05, icon: <Dumbbell size={24}/> },
        { id: 'swing', name: '검술 휘두르기', desc: '모든 대원의 공격력 +3%', costBase: 1500, costScale: 1.6, stat: 'atk', val: 0.03, icon: <Swords size={24}/> },
        { id: 'meditation', name: '전집중 호흡 상중', desc: '치명타 확률 +1%', costBase: 3000, costScale: 2.0, stat: 'crit', val: 1, icon: <Zap size={24}/> },
        { id: 'reflex', name: '반사 신경 훈련', desc: '스킬 쿨타임 감소 1%', costBase: 5000, costScale: 2.5, stat: 'cooldown', val: 0.01, icon: <Sparkles size={24}/> },
      ];

      const SLAYERS_DATA = [
        { id: 'tanjiro', name: '카마도 탄지로', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 180, baseAtk: 45, price: 0, description: '후각이 뛰어나며, 전설의 호흡을 계승한 소년.', skill: { name: '히노카미 카구라: 원무', damageMultiplier: 4.5, cooldown: 6, description: '호흡을 불꽃으로 바꾸어 강력한 베기를 날린다.', isUltimate: true }, awakenSkill: { name: '히노카미 카구라: 비륜양염', damageMultiplier: 7.0, cooldown: 12, description: '칼날이 아지랑이처럼 흔들리며 베어낸다.', isUltimate: true }, color: 'bg-emerald-600' },
        { id: 'zenitsu', name: '아가츠마 젠이츠', style: BreathingStyle.THUNDER, role: Role.ATTACKER, baseHp: 135, baseAtk: 70, price: 300, description: '극도의 공포 속에서 잠들면 진정한 힘을 발휘한다.', skill: { name: '벽력일섬: 육연', damageMultiplier: 3.5, cooldown: 4, description: '보이지 않는 속도로 적을 6번 벤다.' }, awakenSkill: { name: '벽력일섬: 신속', damageMultiplier: 6.0, cooldown: 10, description: '한계 속도를 넘어선 일격.' }, color: 'bg-yellow-500' },
        { id: 'inosuke', name: '하시비라 이노스케', style: BreathingStyle.BEAST, role: Role.ATTACKER, baseHp: 225, baseAtk: 35, price: 400, description: '저돌적인 야생의 전사.', skill: { name: '제3의 이빨: 뜯어 발기기', damageMultiplier: 3.0, cooldown: 4, description: '쌍검으로 적의 목을 노린다.' }, awakenSkill: { name: '제9의 이빨: 신・으스름 베기', damageMultiplier: 5.5, cooldown: 9, description: '관절을 빼서 리치를 늘려 공격한다.' }, color: 'bg-blue-400' },
        { id: 'nezuko', name: '카마도 네즈코', style: BreathingStyle.BLOOD, role: Role.ATTACKER, baseHp: 250, baseAtk: 55, price: 1500, description: '탄지로의 여동생. 혈귀술을 사용한다.', skill: { name: '혈귀술: 폭혈', damageMultiplier: 4.0, cooldown: 5, description: '자신의 피를 불태워 적을 공격한다.' }, awakenSkill: { name: '각성: 오니화', damageMultiplier: 6.5, cooldown: 15, description: '성인 형상으로 변하여 무자비하게 공격한다.' }, color: 'bg-rose-500' },
        { id: 'genya', name: '시나즈가와 겐야', style: BreathingStyle.NONE, role: Role.ATTACKER, baseHp: 270, baseAtk: 55, price: 800, description: '호흡을 쓸 수 없어 총과 혈귀 먹기를 사용한다.', skill: { name: '남만총 사격', damageMultiplier: 2.8, cooldown: 3, description: '총으로 견제하고 물어뜯어 회복한다.' }, awakenSkill: { name: '혈귀술: 무간업수', damageMultiplier: 5.0, cooldown: 10, description: '혈귀를 먹고 얻은 힘으로 나무 뿌리를 조종한다.' }, color: 'bg-slate-600' },
        { id: 'kanao', name: '츠유리 카나오', style: BreathingStyle.FLOWER, role: Role.ATTACKER, baseHp: 195, baseAtk: 60, price: 1200, description: '뛰어난 동체시력을 가진 츠구코.', skill: { name: '제4형: 홍화의', damageMultiplier: 3.5, cooldown: 5, description: '부드러운 곡선을 그리며 베어낸다.' }, awakenSkill: { name: '종의 형: 피안주안', damageMultiplier: 7.5, cooldown: 15, description: '실명할 위험을 감수하고 모든 움직임을 꿰뚫어본다.' }, color: 'bg-pink-400' },
        { id: 'giyu', name: '토미오카 기유', style: BreathingStyle.WATER, role: Role.ATTACKER, baseHp: 300, baseAtk: 85, price: 2200, description: '냉철하고 침착한 물의 지주.', skill: { name: '제11형: 잔잔한 물결', damageMultiplier: 3.5, cooldown: 5, description: '모든 공격을 무효화하고 반격한다.' }, awakenSkill: { name: '제10형: 생생유전 (극)', damageMultiplier: 6.5, cooldown: 10, description: '극한까지 회전력을 높인 용의 일격.' }, color: 'bg-blue-800' },
        { id: 'shinobu', name: '코쵸우 시노부', style: BreathingStyle.INSECT, role: Role.ATTACKER, baseHp: 150, baseAtk: 45, price: 1800, description: '독을 사용하여 오니를 멸살한다.', skill: { name: '나비의 춤: 장난', damageMultiplier: 2.5, cooldown: 3, description: '빠르게 찌르며 치명적인 독을 주입한다.' }, awakenSkill: { name: '지네의 춤: 백족 쟈바라', damageMultiplier: 6.0, cooldown: 9, description: '엄청난 속도로 사방에서 찌른다.' }, color: 'bg-purple-600' },
        { id: 'rengoku', name: '렌고쿠 쿄주로', style: BreathingStyle.FLAME, role: Role.ATTACKER, baseHp: 330, baseAtk: 105, price: 3200, description: '마음을 불태우는 열정적인 지주.', skill: { name: '제5형: 염호', damageMultiplier: 4.5, cooldown: 7, description: '맹호가 물어뜯는 듯한 참격.' }, awakenSkill: { name: '제9형: 연옥', damageMultiplier: 8.0, cooldown: 14, description: '전신을 불태우며 돌진하는 오의.' }, color: 'bg-red-600' },
        { id: 'tengen', name: '우즈이 텐겐', style: BreathingStyle.SOUND, role: Role.ATTACKER, baseHp: 360, baseAtk: 98, price: 2800, description: '화려함을 추구하는 닌자 출신 지주.', skill: { name: '제5형: 명현주주', damageMultiplier: 3.8, cooldown: 6, description: '회전하는 칼날로 폭발적인 소리를 낸다.' }, awakenSkill: { name: '악보 완성', damageMultiplier: 7.0, cooldown: 13, description: '적의 공격 리듬을 완벽하게 파악하여 반격한다.' }, color: 'bg-fuchsia-600' },
        { id: 'mitsuri', name: '칸로지 미츠리', style: BreathingStyle.LOVE, role: Role.ATTACKER, baseHp: 300, baseAtk: 90, price: 2500, description: '특이 체질 근육을 가진 사랑의 지주.', skill: { name: '제5형: 흔들리는 연정', damageMultiplier: 4.0, cooldown: 6, description: '채찍 같은 검으로 광범위하게 공격한다.' }, awakenSkill: { name: '제6형: 고양이 발 사랑 바람', damageMultiplier: 6.8, cooldown: 11, description: '빠르게 몸을 회전하며 모든 공격을 쳐낸다.' }, color: 'bg-pink-500' },
        { id: 'obanai', name: '이구로 오바나이', style: BreathingStyle.SERPENT, role: Role.ATTACKER, baseHp: 220, baseAtk: 95, price: 2600, description: '뱀처럼 휘어지는 검로를 구사하는 지주.', skill: { name: '제2형: 협두의 독니', damageMultiplier: 3.8, cooldown: 5, description: '뱀이 기어가듯 적의 뒤를 노린다.' }, awakenSkill: { name: '제5형: 원원장사', damageMultiplier: 7.2, cooldown: 12, description: '광범위하게 뱀처럼 휘어지는 참격을 날린다.' }, color: 'bg-violet-800' },
        { id: 'muichiro', name: '토키토 무이치로', style: BreathingStyle.MIST, role: Role.ATTACKER, baseHp: 240, baseAtk: 128, price: 3800, description: '천재적인 재능을 가진 최연소 지주.', skill: { name: '제4형: 이류베기', damageMultiplier: 4.0, cooldown: 6, description: '흐르듯이 베어내는 참격.' }, awakenSkill: { name: '제7형: 몽롱', damageMultiplier: 7.5, cooldown: 11, description: '안개 속에 숨어 적을 교란시키며 벤다.' }, color: 'bg-teal-400' },
        { id: 'sanemi', name: '시나즈가와 사네미', style: BreathingStyle.WIND, role: Role.ATTACKER, baseHp: 350, baseAtk: 120, price: 4200, description: '가장 호전적이고 파괴적인 바람의 지주.', skill: { name: '제1형: 진선풍 깎기', damageMultiplier: 4.5, cooldown: 5, description: '지면을 부수며 돌진하는 참격.' }, awakenSkill: { name: '제8형: 초열풍 베기', damageMultiplier: 8.0, cooldown: 12, description: '폭풍처럼 몰아치는 연격.' }, color: 'bg-green-700' },
        { id: 'gyomei', name: '히메지마 교메이', style: BreathingStyle.STONE, role: Role.ATTACKER, baseHp: 525, baseAtk: 150, price: 6000, description: '귀살대 최강의 사나이.', skill: { name: '제2형: 천면 부수기', damageMultiplier: 5.0, cooldown: 8, description: '철퇴를 머리 위로 던져 내려찍는다.' }, awakenSkill: { name: '제5형: 와륜 형부', damageMultiplier: 9.0, cooldown: 16, description: '거대한 철퇴와 도끼로 적을 완전히 분쇄한다.' }, color: 'bg-stone-600' },
        { id: 'yoriichi', name: '츠기쿠니 요리이치', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 750, baseAtk: 300, price: 25000, description: '모든 호흡의 시초이자 최강의 검사.', skill: { name: '해의 호흡: 13형', damageMultiplier: 12.0, cooldown: 12, description: '무잔조차 공포에 떨게 만든 전설의 검기.' }, awakenSkill: { name: '혁도 발현', damageMultiplier: 15.0, cooldown: 20, description: '검을 붉게 물들여 재생을 봉쇄하고 벤다.' }, color: 'bg-red-800' },
        { id: 'yoriichi_god', name: '태양의 신 요리이치', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 1500, baseAtk: 600, price: 100000, currency: 'LILY', lilyPrice: 10000, description: '신에 근접한 검사. 오니화 탄지로조차 능가한다.', skill: { name: '해의 호흡: 일광', damageMultiplier: 8.0, cooldown: 4, description: '태양 그 자체의 열기로 적을 소멸시킨다.' }, awakenSkill: { name: '제13형: 신라만상', damageMultiplier: 25.0, cooldown: 15, description: '세상의 모든 이치를 담은, 피할 수 없는 일격.' }, color: 'bg-orange-700 text-yellow-100 border-2 border-yellow-400' },
        
        // SUPPORTERS
        { id: 'tamayo', name: '타마요', style: BreathingStyle.BLOOD, role: Role.SUPPORTER, baseHp: 180, baseAtk: 40, price: 1600, description: '무잔을 적대하는 의사 혈귀. 아군을 치료한다.', skill: { name: '혈귀술: 시각몽환의 향', damageMultiplier: 2.0, cooldown: 5, description: '적을 교란시키고 아군 하나를 치료한다.' }, awakenSkill: { name: '치료의 약', damageMultiplier: 0, cooldown: 10, description: '아군 전체의 체력을 회복시킨다.' }, color: 'bg-purple-800' },
        { id: 'yushiro', name: '유시로', style: BreathingStyle.BLOOD, role: Role.SUPPORTER, baseHp: 200, baseAtk: 50, price: 1600, description: '타마요를 모시는 혈귀.', skill: { name: '혈귀술: 눈가림', damageMultiplier: 1.5, cooldown: 4, description: '모습을 감추어 적의 공격을 회피하고 기습한다.' }, awakenSkill: { name: '시야 공유', damageMultiplier: 0, cooldown: 10, description: '아군의 치명타 확률을 대폭 상승시킨다.' }, color: 'bg-teal-700' },
        { id: 'aoi', name: '칸자키 아오이', style: BreathingStyle.WATER, role: Role.SUPPORTER, baseHp: 160, baseAtk: 40, price: 500, description: '나비 저택에서 대원들을 돕는 대원.', skill: { name: '응급 처치', damageMultiplier: 1.0, cooldown: 5, description: '약한 공격 후 아군을 소폭 회복한다.' }, awakenSkill: { name: '전력 간호', damageMultiplier: 0, cooldown: 10, description: '아군 전체를 회복시킨다.' }, color: 'bg-blue-500' },
        { id: 'enmu', name: '엔무 (하현 1)', style: BreathingStyle.DREAM, role: Role.SUPPORTER, baseHp: 300, baseAtk: 40, price: 18000, description: '적을 잠재우고 아군에게 활력을 불어넣는다.', skill: { name: '혈귀술: 강제 혼수', damageMultiplier: 0, cooldown: 8, description: '아군 전체를 치유하고 적의 공격 턴을 늦춘다.' }, awakenSkill: { name: '행복한 꿈', damageMultiplier: 0, cooldown: 15, description: '아군 전체의 체력을 대폭 회복하고 공격력을 강화한다.' }, color: 'bg-indigo-950 text-pink-300' },
        { id: 'kotetsu', name: '코테츠', style: BreathingStyle.NONE, role: Role.SUPPORTER, baseHp: 150, baseAtk: 30, price: 3000, description: '대장장이 마을의 어린 장인. 분석력이 뛰어나다.', skill: { name: '약점 분석', damageMultiplier: 2.0, cooldown: 6, description: '적의 구조를 파악하여 치명타 확률을 높인다.' }, awakenSkill: { name: '기관 장치 가동', damageMultiplier: 5.0, cooldown: 15, description: '전투용 꼭두각시를 조종하여 공격한다.' }, color: 'bg-stone-500' },
        { id: 'yahaba', name: '야하바', style: BreathingStyle.ARROW, role: Role.SUPPORTER, baseHp: 350, baseAtk: 80, price: 8000, description: '벡터를 조작하는 화살표 오니.', skill: { name: '홍결의 화살', damageMultiplier: 2.5, cooldown: 4, description: '적의 공격 궤도를 틀어 아군 피해를 줄인다.' }, awakenSkill: { name: '벡터 조작', damageMultiplier: 5.0, cooldown: 10, description: '적을 바닥에 내리꽂아 큰 피해를 준다.' }, color: 'bg-green-800' },
        { id: 'senjuro', name: '렌고쿠 센쥬로', style: BreathingStyle.FLAME, role: Role.SUPPORTER, baseHp: 180, baseAtk: 35, price: 4000, description: '쿄쥬로의 동생. 검술 재능은 없지만 마음이 따뜻하다.', skill: { name: '따뜻한 격려', damageMultiplier: 0, cooldown: 8, description: '형의 의지를 잇는다. 아군 전체 쿨타임을 2초 감소시킨다.' }, awakenSkill: { name: '염주의 일지', damageMultiplier: 0, cooldown: 15, description: '대대로 내려오는 기록을 분석하여 아군 전체 공격력을 높인다.' }, color: 'bg-orange-300' },
        { id: 'kiriya', name: '우부야시키 키리야', style: BreathingStyle.NONE, role: Role.SUPPORTER, baseHp: 200, baseAtk: 20, price: 15000, description: '새로운 당주. 뛰어난 기억력과 지휘 능력을 가졌다.', skill: { name: '전황 파악', damageMultiplier: 0, cooldown: 6, description: '적의 위치를 간파하여 아군 치명타 확률을 높인다.' }, awakenSkill: { name: '지휘 관제', damageMultiplier: 0, cooldown: 14, description: '지도를 그려내듯 전장을 지휘해 아군 전체 능력을 대폭 상승시킨다.' }, color: 'bg-slate-900 text-purple-300' },
        
        // VILLAINS
        { id: 'rui', name: '루이 (하현 5)', style: BreathingStyle.THREAD, role: Role.ATTACKER, baseHp: 400, baseAtk: 120, price: 15000, description: '단단한 실을 사용하는 거미 오니.', skill: { name: '혈귀술: 각사뢰', damageMultiplier: 4.0, cooldown: 5, description: '붉은 실로 적을 절단한다.' }, awakenSkill: { name: '살목롱', damageMultiplier: 7.5, cooldown: 11, description: '실로 만든 감옥에 가두어 베어버린다.' }, color: 'bg-slate-200 text-red-600' },
        { id: 'susamaru', name: '스사마루', style: BreathingStyle.TEMARI, role: Role.ATTACKER, baseHp: 380, baseAtk: 110, price: 8500, description: '6개의 팔로 공을 던지는 오니.', skill: { name: '놀이공 던지기', damageMultiplier: 3.5, cooldown: 3, description: '빠르게 속도로 공을 던져 공격한다.' }, awakenSkill: { name: '6연속 투척', damageMultiplier: 7.0, cooldown: 8, description: '모든 팔을 이용하여 쉴 새 없이 공을 던진다.' }, color: 'bg-orange-600' },
        { id: 'kokushibo_demon', name: '코쿠시보 (상현 1)', style: BreathingStyle.MOON, role: Role.ATTACKER, baseHp: 800, baseAtk: 350, price: 100000, currency: 'LILY', lilyPrice: 5000, description: '달의 호흡을 사용하는 최강의 상현. (플레이어블)', skill: { name: '제7형: 액경・달의 춤', damageMultiplier: 5.0, cooldown: 5, description: '원거리에서 교차하는 달의 참격을 날린다.' }, awakenSkill: { name: '제16형: 월홍・반월', damageMultiplier: 12.0, cooldown: 15, description: '하늘에서 무수한 거대 참격을 떨어뜨려 전장을 초토화한다.' }, color: 'bg-purple-950 text-red-500' },
        { id: 'doma_demon', name: '도우마 (상현 2)', style: BreathingStyle.ICE, role: Role.ATTACKER, baseHp: 750, baseAtk: 300, price: 80000, currency: 'LILY', lilyPrice: 4000, description: '만세극락교의 교주. 얼음을 다루는 혈귀.', skill: { name: '혈귀술: 연꽃 얼음', damageMultiplier: 4.5, cooldown: 6, description: '얼음 연꽃을 피워 적을 베어내고 얼린다.' }, awakenSkill: { name: '혈귀술: 무빙・수련보살', damageMultiplier: 10.0, cooldown: 14, description: '거대한 얼음 불상을 소환하여 압도적인 냉기를 뿜는다.' }, color: 'bg-cyan-900 text-white' },
        { id: 'dk_tanjiro', name: '오니화 탄지로', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 1000, baseAtk: 400, price: 50000, description: '태양을 극복한 오니의 왕. 해의 호흡과 혈귀술을 동시에 쓴다.', skill: { name: '혈귀술: 충격파', damageMultiplier: 5.0, cooldown: 5, description: '등에서 촉수를 꺼내 충격파를 발사한다.' }, awakenSkill: { name: '태양 극복', damageMultiplier: 20.0, cooldown: 25, description: '죽음을 초월한 일격으로 모든 것을 소멸시킨다.' }, color: 'bg-rose-950' },
        { id: 'yoriichi_zero', name: '요리이치 영식', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 450, baseAtk: 140, price: 5000, description: '전설의 검사를 본따 만든 전투 인형. 팔이 6개다.', skill: { name: '6연격', damageMultiplier: 4.5, cooldown: 8, description: '6개의 팔을 이용한 쉴새없는 공격.' }, awakenSkill: { name: '과부하 회전', damageMultiplier: 8.0, cooldown: 16, description: '기계 장치를 한계까지 돌려 회전하며 벤다.' }, color: 'bg-red-900' },
        { id: 'kaigaku', name: '카이가쿠', style: BreathingStyle.THUNDER, role: Role.ATTACKER, baseHp: 200, baseAtk: 75, price: 1000, description: '힘을 추구하여 오니가 된 번개의 호흡 사용자.', skill: { name: '제2형: 도혼', damageMultiplier: 3.2, cooldown: 4, description: '빠르게 5번 연속으로 벤다.' }, awakenSkill: { name: '제6형: 전굉뢰굉', damageMultiplier: 6.5, cooldown: 12, description: '검은 번개를 두르고 광범위하게 파괴한다.' }, color: 'bg-neutral-800' },
        { id: 'murata', name: '무라타', style: BreathingStyle.WATER, role: Role.ATTACKER, baseHp: 150, baseAtk: 30, price: 200, description: '어디에나 있는 평범한 대원. 하지만 생존력은 최강.', skill: { name: '물의 호흡(흐릿함)', damageMultiplier: 2.0, cooldown: 3, description: '형태가 보이지 않을 정도로 옅은 물의 호흡.' }, awakenSkill: { name: '기적의 생존', damageMultiplier: 4.0, cooldown: 15, description: '엄청난 운으로 적의 급소를 찌르고 회피한다.' }, color: 'bg-slate-500' },
        { id: 'wives', name: '우즈이의 아내들', style: BreathingStyle.SOUND, role: Role.ATTACKER, baseHp: 240, baseAtk: 65, price: 1100, description: '스마, 마키오, 히나츠루 3인조 쿠노이치.', skill: { name: '쿠나이 난사', damageMultiplier: 3.2, cooldown: 4, description: '독이 발린 쿠나이를 사방에서 던진다.' }, awakenSkill: { name: '지원 사격', damageMultiplier: 6.0, cooldown: 12, description: '대규모 화약과 무기로 적을 포위 공격한다.' }, color: 'bg-pink-600' },
        { id: 'michikatsu', name: '츠기쿠니 미치카츠', style: BreathingStyle.MOON, role: Role.ATTACKER, baseHp: 650, baseAtk: 250, price: 18000, description: '요리이치의 형이자 달의 호흡 창시자. (인간 시절)', skill: { name: '달의 호흡: 제1형 암월·전궁', damageMultiplier: 6.0, cooldown: 6, description: '발도와 동시에 수많은 초승달 칼날을 날린다.' }, awakenSkill: { name: '달의 호흡 극한', damageMultiplier: 10.0, cooldown: 14, description: '인간의 몸으로 극한까지 끌어올린 달의 호흡.' }, color: 'bg-purple-900' },
        { id: 'hakuji', name: '하쿠지', style: BreathingStyle.NONE, role: Role.ATTACKER, baseHp: 500, baseAtk: 200, price: 15000, description: '오니가 되기 전의 아카자. 소류 무술의 달인.', skill: { name: '파괴살: 나침', damageMultiplier: 5.5, cooldown: 5, description: '투기를 감지하여 치명타 확률을 높여 타격한다.' }, awakenSkill: { name: '청은난류광', damageMultiplier: 9.0, cooldown: 12, description: '백 발의 난타를 동시에 꽂아넣는다.' }, color: 'bg-pink-700' },
        { id: 'sumiyoshi', name: '스미요시', style: BreathingStyle.SUN, role: Role.ATTACKER, baseHp: 200, baseAtk: 50, price: 5000, description: '요리이치의 검무를 눈에 새긴 카마도 가문의 조상.', skill: { name: '약속의 기억', damageMultiplier: 3.5, cooldown: 5, description: '요리이치와의 약속을 떠올리며 힘을 낸다.' }, awakenSkill: { name: '해의 호흡: 12형의 춤', damageMultiplier: 8.0, cooldown: 14, description: '밤새도록 멈추지 않고 춤을 춘다.' }, color: 'bg-amber-700' },
        { id: 'shinjuro', name: '렌고쿠 신쥬로', style: BreathingStyle.FLAME, role: Role.ATTACKER, baseHp: 420, baseAtk: 130, price: 4800, description: '전 염주이자 쿄쥬로의 아버지. 과거에는 열정적이었다.', skill: { name: '제4형: 성염의 파도', damageMultiplier: 4.5, cooldown: 6, description: '소용돌이치는 화염으로 방어와 공격을 동시에 한다.' }, awakenSkill: { name: '염주의 품격', damageMultiplier: 8.5, cooldown: 13, description: '녹슨 검술을 다시 불태워 강력한 일격을 날린다.' }, color: 'bg-red-800' },
        { id: 'sabito_spirit', name: '사비토 (영혼)', style: BreathingStyle.WATER, role: Role.ATTACKER, baseHp: 220, baseAtk: 70, price: 4500, description: '가면이 깨진 진정한 모습의 사비토.', skill: { name: '쾌도난마', damageMultiplier: 4.0, cooldown: 5, description: '망설임 없는 검격으로 적을 벤다.' }, awakenSkill: { name: '진정한 용기', damageMultiplier: 7.5, cooldown: 11, description: '모두를 지키겠다는 일념으로 한계를 초월한다.' }, color: 'bg-orange-400' },
      ];

      const ENEMY_TEMPLATES = [
        { name: '약한 오니', maxHp: 30, atk: 4, rewardGold: 20, isBoss: false, imageColor: 'text-gray-400' },
        { name: '굶주린 오니', maxHp: 50, atk: 6, rewardGold: 30, isBoss: false, imageColor: 'text-gray-500' },
        { name: '사당 도깨비', maxHp: 80, atk: 10, rewardGold: 50, isBoss: false, imageColor: 'text-stone-500' },
        { name: '손 도깨비', maxHp: 200, atk: 20, rewardGold: 150, isBoss: true, imageColor: 'text-green-800', skillProb: 0.1, skillName: '거대한 손', skillDmgMult: 1.5 },
        { name: '늪 도깨비', maxHp: 250, atk: 25, rewardGold: 200, isBoss: false, imageColor: 'text-blue-900' },
        { name: '야하바 & 스사마루', maxHp: 350, atk: 35, rewardGold: 250, isBoss: true, imageColor: 'text-orange-700', skillProb: 0.2, skillName: '공과 화살', skillDmgMult: 1.6 },
        { name: '거미 도깨비 (아빠)', maxHp: 400, atk: 40, rewardGold: 300, isBoss: false, imageColor: 'text-gray-200' },
        
        { name: '전 하현 6: 쿄우가이', maxHp: 600, atk: 50, rewardGold: 500, isBoss: true, imageColor: 'text-orange-800', skillProb: 0.2, skillName: '북치기', skillDmgMult: 1.8 },
        { name: '하현 6: 카마누에', maxHp: 650, atk: 55, rewardGold: 550, isBoss: true, imageColor: 'text-green-600', skillProb: 0.2, skillName: '환각', skillDmgMult: 1.5 },
        { name: '하현 4: 무카고', maxHp: 700, atk: 60, rewardGold: 600, isBoss: true, imageColor: 'text-gray-400', skillProb: 0.2, skillName: '도망치기', skillDmgMult: 1.2 },
        { name: '하현 3: 와쿠라바', maxHp: 750, atk: 65, rewardGold: 650, isBoss: true, imageColor: 'text-stone-600', skillProb: 0.2, skillName: '고속 이동', skillDmgMult: 1.5 },
        { name: '하현 2: 로쿠로', maxHp: 780, atk: 68, rewardGold: 680, isBoss: true, imageColor: 'text-stone-800', skillProb: 0.2, skillName: '지진', skillDmgMult: 1.6 },
        { name: '하현 5: 루이', maxHp: 800, atk: 70, rewardGold: 700, isBoss: true, imageColor: 'text-red-500', skillProb: 0.25, skillName: '각사뢰', skillDmgMult: 2.0 },
        { name: '하현 1: 엔무', maxHp: 1200, atk: 100, rewardGold: 1200, isBoss: true, imageColor: 'text-indigo-500', skillProb: 0.2, skillName: '강제 혼수 최면', skillDmgMult: 0.5 }, 

        { name: '신 상현 6: 카이가쿠', maxHp: 2000, atk: 160, rewardGold: 2500, isBoss: true, imageColor: 'text-neutral-500', skillProb: 0.3, skillName: '검은 번개', skillDmgMult: 2.1 },
        { name: '상현 6: 다키 & 규타로', maxHp: 2500, atk: 180, rewardGold: 3000, isBoss: true, imageColor: 'text-lime-500', skillProb: 0.3, skillName: '피의 참격', skillDmgMult: 2.2 },
        { name: '상현 5: 굣코', maxHp: 4000, atk: 250, rewardGold: 5000, isBoss: true, imageColor: 'text-purple-300', skillProb: 0.3, skillName: '수옥발', skillDmgMult: 2.5 },
        { name: '상현 4: 한텐구', maxHp: 6500, atk: 350, rewardGold: 7000, isBoss: true, imageColor: 'text-yellow-700', skillProb: 0.3, skillName: '목룡', skillDmgMult: 2.8 },
        { name: '신 상현 4: 나키메', maxHp: 8000, atk: 400, rewardGold: 9000, isBoss: true, imageColor: 'text-slate-600', skillProb: 0.35, skillName: '공간 조작', skillDmgMult: 0.8 },
        { name: '상현 3: 아카자', maxHp: 12000, atk: 600, rewardGold: 12000, isBoss: true, imageColor: 'text-pink-600', skillProb: 0.35, skillName: '파괴살: 나침', skillDmgMult: 3.0 },
        { name: '상현 2: 도우마', maxHp: 16000, atk: 800, rewardGold: 20000, isBoss: true, imageColor: 'text-cyan-300', skillProb: 0.35, skillName: '무빙 연꽃', skillDmgMult: 3.5 },
        { name: '상현 1: 코쿠시보', maxHp: 25000, atk: 1500, rewardGold: 40000, isBoss: true, imageColor: 'text-purple-900', skillProb: 0.4, skillName: '달의 호흡', skillDmgMult: 4.0 },
        
        { name: '키부츠지 무잔', maxHp: 50000, atk: 3000, rewardGold: 100000, isBoss: true, imageColor: 'text-red-700', skillProb: 0.5, skillName: '촉수 난무', skillDmgMult: 5.0 },
      ];

      const SYNERGIES = [
        {
          name: '뱀과 사랑',
          description: '오바나이와 미츠리가 함께하면 공격력 25% 증가',
          condition: (ids) => ids.includes('obanai') && ids.includes('mitsuri'),
          apply: (id, stats) => {
             if (id === 'obanai' || id === 'mitsuri') {
               return { ...stats, atk: Math.floor(stats.atk * 1.25) };
             }
             return stats;
          }
        },
        {
            name: '최강의 형제',
            description: '요리이치와 미치카츠가 함께하면 치명타 피해 50% 증가',
            condition: (ids) => ids.includes('yoriichi') && ids.includes('michikatsu'),
            apply: (id, stats) => { return stats; } 
        },
        {
            name: '거미 가족',
            description: '루이와 2명 이상의 오니가 함께하면 전체 체력 20% 증가',
            condition: (ids) => {
                const demons = ['rui', 'spider_dad', 'spider_mom', 'spider_sister'];
                return ids.includes('rui') && ids.filter(id => SLAYERS_DATA.find(s=>s.id===id)?.style === BreathingStyle.BLOOD || SLAYERS_DATA.find(s=>s.id===id)?.role === Role.SUPPORTER).length >= 2;
            },
            apply: (id, stats) => {
                 return { ...stats, maxHp: Math.floor(stats.maxHp * 1.2) };
            }
        },
        {
          name: '무한열차 팀',
          description: '탄지로, 젠이츠, 이노스케, 렌고쿠가 함께하면 체력/공격력 20% 증가',
          condition: (ids) => ids.includes('tanjiro') && ids.includes('zenitsu') && ids.includes('inosuke') && ids.includes('rengoku'),
          apply: (id, stats) => {
             if (['tanjiro', 'zenitsu', 'inosuke', 'rengoku'].includes(id)) {
               return { 
                 atk: Math.floor(stats.atk * 1.2), 
                 maxHp: Math.floor(stats.maxHp * 1.2) 
               };
             }
             return stats;
          }
        },
        {
          name: '불사천 형제',
          description: '사네미와 겐야가 함께하면 체력 30% 증가',
          condition: (ids) => ids.includes('sanemi') && ids.includes('genya'),
          apply: (id, stats) => {
            if (id === 'sanemi' || id === 'genya') {
              return { ...stats, maxHp: Math.floor(stats.maxHp * 1.3) };
            }
            return stats;
          }
        },
        {
            name: '의사와 조수',
            description: '타마요와 유시로가 함께하면 체력 재생 효과',
            condition: (ids) => ids.includes('tamayo') && ids.includes('yushiro'),
            apply: (id, stats) => { return stats; }
        },
        {
            name: '상현의 오니',
            description: '상현(코쿠시보, 도우마, 아카자 등)이 2명 이상 모이면 공격력 30% 증가',
            condition: (ids) => {
                const demons = ['kokushibo_demon', 'doma_demon', 'kaigaku', 'hakuji', 'michikatsu'];
                return ids.filter(id => demons.includes(id)).length >= 2;
            },
             apply: (id, stats) => {
                const demons = ['kokushibo_demon', 'doma_demon', 'kaigaku', 'hakuji', 'michikatsu'];
                if(demons.includes(id)) return { ...stats, atk: Math.floor(stats.atk * 1.3) };
                return stats;
            }
        }
      ];

      const ARTIFACT_RARITY = {
        COMMON: { name: '일반', color: 'text-slate-400', border: 'border-slate-600', dropRate: 0.6 },
        RARE: { name: '희귀', color: 'text-blue-400', border: 'border-blue-500', dropRate: 0.3 },
        EPIC: { name: '영웅', color: 'text-purple-400', border: 'border-purple-500', dropRate: 0.09 },
        LEGENDARY: { name: '전설', color: 'text-yellow-400', border: 'border-yellow-500', dropRate: 0.01 }
      };

      const ARTIFACT_TEMPLATES = [
        { id: 'tanjirou_earrings', name: '탄지로의 귀걸이', rarity: 'LEGENDARY', type: 'stat_boost', stat: 'atk', val: 0.5, desc: '해의 호흡 계승자의 증표. 공격력 50% 증가' },
        { id: 'sabito_mask', name: '사비토의 가면', rarity: 'EPIC', type: 'crit_rate', val: 0.15, desc: '액운을 막아주는 가면. 치명타 확률 15% 증가' },
        { id: 'rengoku_guard', name: '렌고쿠의 코등이', rarity: 'EPIC', type: 'crit_dmg', val: 0.5, desc: '불꽃 모양의 코등이. 치명타 피해 50% 증가' },
        { id: 'nezuko_bamboo', name: '네즈코의 대나무', rarity: 'RARE', type: 'leech', val: 0.1, desc: '오니의 본능을 억제한다. 피해량의 10% 흡혈' },
        { id: 'zenitsu_haori', name: '젠이츠의 하오리', rarity: 'RARE', type: 'cooldown', val: 0.1, desc: '번개 무늬 하오리. 쿨타임 10% 감소' },
        { id: 'inosuke_mask', name: '멧돼지 탈', rarity: 'COMMON', type: 'stat_boost', stat: 'atk', val: 0.1, desc: '저돌맹진! 공격력 10% 증가' },
        { id: 'shinobu_medicine', name: '등꽃 독', rarity: 'RARE', type: 'stat_boost', stat: 'atk', val: 0.2, desc: '오니에게 치명적인 독. 공격력 20% 증가' },
        { id: 'uzui_bandana', name: '우즈이의 두건', rarity: 'EPIC', type: 'crit_rate', val: 0.1, desc: '화려한 두건. 치명타 확률 10% 증가' },
        { id: 'muichiro_origami', name: '무이치로의 종이', rarity: 'COMMON', type: 'cooldown', val: 0.05, desc: '멍하니 접은 종이비행기. 쿨타임 5% 감소' },
        { id: 'kanao_coin', name: '카나오의 동전', rarity: 'COMMON', type: 'crit_rate', val: 0.05, desc: '앞면? 뒷면? 치명타 확률 5% 증가' },
        { id: 'kokushibo_kimono', name: '코쿠시보의 기모노', rarity: 'LEGENDARY', type: 'crit_rate', val: 0.3, desc: '6개의 눈이 그려진 옷. 치명타 확률 30% 증가' },
        { id: 'akaza_beads', name: '아카자의 염주', rarity: 'EPIC', type: 'stat_boost', stat: 'atk', val: 0.4, desc: '파괴살의 기운. 공격력 40% 증가' },
        { id: 'doma_fan', name: '도우마의 황금 부채', rarity: 'LEGENDARY', type: 'crit_dmg', val: 0.8, desc: '차가운 냉기를 머금은 부채. 치명타 피해 80% 증가' },
        { id: 'nakime_biwa', name: '나키메의 비파 채', rarity: 'EPIC', type: 'cooldown', val: 0.2, desc: '공간을 조작하는 소리. 쿨타임 20% 감소' },
        { id: 'gyokko_pot', name: '굣코의 항아리', rarity: 'EPIC', type: 'stat_boost', stat: 'gold', val: 0.5, desc: '예술적인 항아리? 골드 획득량 증가' },
        { id: 'blue_lily_leaf', name: '푸른 피안화 잎', rarity: 'LEGENDARY', type: 'stat_boost', stat: 'maxHp', val: 1.0, desc: '영생의 비밀. 체력 100% 증가' },
        { id: 'muzans_blood', name: '무잔의 혈액', rarity: 'LEGENDARY', type: 'stat_boost', stat: 'atk', val: 0.8, desc: '오니의 시초의 피. 공격력 80% 증가' },
        { id: 'yoriichi_flute', name: '요리이치의 피리', rarity: 'LEGENDARY', type: 'cooldown', val: 0.3, desc: '형이 준 선물. 쿨타임 30% 감소' }
      ];

      const ProgressBar = ({ current, max, colorClass, label, height = "h-4" }) => {
        const percentage = Math.min(100, Math.max(0, (current / max) * 100));

        return (
          <div className="w-full relative">
            <div className={`w-full bg-gray-800 rounded-full overflow-hidden border border-gray-700 ${height}`}>
              <div
                className={`${colorClass} ${height} transition-all duration-300 ease-out flex items-center justify-center`}
                style={{ width: `${percentage}%` }}
              >
              </div>
            </div>
            {label && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <span className="text-xs font-bold text-white drop-shadow-md tracking-wider uppercase">{label}</span>
              </div>
            )}
          </div>
        );
      };

      // Unified Save Key - stops data loss on updates
      const MASTER_SAVE_KEY = 'ds_rpg_master_save_unified';
      const V1_SAVE_KEY = 'ds_rpg_save_v1';

      const getSynergies = (selectedIds) => {
        return SYNERGIES.filter(s => s.condition(selectedIds));
      };

      const getDifficultyMultiplier = (diff) => {
        switch(diff) {
          case 'EASY': return 0.8;
          case 'NORMAL': return 1.0;
          case 'HARD': return 1.5;
          default: return 1.0;
        }
      };

      const getRewardMultiplier = (diff) => {
        switch(diff) {
          case 'EASY': return 0.8;
          case 'NORMAL': return 1.0;
          case 'HARD': return 1.5;
          default: return 1.0;
        }
      };

      // 0. Management View
      const ManagementView = ({ 
        player, 
        onBack,
        onUpgrade,
        onPromote,
        onAwakenMark,
        onRefineWeapon,
        onEquipArtifact,
        onUnequipArtifact,
        onToggleSlayer,
        onLimitBreak,
        onUpgradeSkill
      }) => {
         const [selectedSlayerId, setSelectedSlayerId] = useState(player.ownedSlayers[0]?.id);
         const [sortMode, setSortMode] = useState('LEVEL'); // LEVEL, RANK, ATK
         const [activeTab, setActiveTab] = useState('STATUS'); // STATUS, SKILL, EQUIP

         const selectedSlayer = player.ownedSlayers.find(s => s.id === selectedSlayerId);
         const equippedArtifact = selectedSlayer ? player.inventory.find(i => i.id === selectedSlayer.equippedArtifactId) : null;

         const sortedSlayers = [...player.ownedSlayers].sort((a,b) => {
             if (sortMode === 'LEVEL') return b.level - a.level;
             if (sortMode === 'RANK') return (b.rankIdx || 0) - (a.rankIdx || 0);
             if (sortMode === 'ATK') return b.atk - a.atk;
             return 0;
         });

         const currentRank = selectedSlayer ? RANKS[selectedSlayer.rankIdx || 0] : null;
         const nextRank = selectedSlayer ? RANKS[(selectedSlayer.rankIdx || 0) + 1] : null;
         
         const upgradeCost = selectedSlayer ? Math.floor(100 * Math.pow(1.2, selectedSlayer.level)) : 0;
         const canUpgrade = selectedSlayer && player.gold >= upgradeCost;
         
         const canPromote = selectedSlayer && nextRank && selectedSlayer.level >= nextRank.minLv && player.gold >= nextRank.cost;
         
         const canMark = selectedSlayer && selectedSlayer.level >= 50;
         const markCost = { gold: 100000, iron: 100 };
         const canAffordMark = player.gold >= markCost.gold && player.ironSand >= markCost.iron;
         
         const limitLevel = selectedSlayer?.limitBreakLevel || 0;
         const maxLimit = 5;
         const canLimitBreak = selectedSlayer && selectedSlayer.level >= (100 + (limitLevel * 50)) && limitLevel < maxLimit;
         const limitCost = { gold: 1000000 * (limitLevel + 1), lily: 10 * (limitLevel + 1), iron: 500 * (limitLevel + 1) };
         const canAffordLimit = player.gold >= limitCost.gold && player.blueLily >= limitCost.lily && player.ironSand >= limitCost.iron;

         const weaponLv = selectedSlayer?.weaponLevel || 0;
         const weaponIronCost = 10 + (weaponLv * 5);
         const weaponGoldCost = 1000 + (weaponLv * 500);
         const canRefine = selectedSlayer && player.ironSand >= weaponIronCost && player.gold >= weaponGoldCost;

         // Skill Upgrade Logic
         const skillLv = selectedSlayer?.skillLevel || 1;
         const awakenSkillLv = selectedSlayer?.awakenSkillLevel || 1;
         const skillUpgradeCost = { gold: 5000 * skillLv, iron: 50 * skillLv };
         const awakenSkillUpgradeCost = { gold: 10000 * awakenSkillLv, iron: 100 * awakenSkillLv };
         const canUpgradeSkill = player.gold >= skillUpgradeCost.gold && player.ironSand >= skillUpgradeCost.iron;
         const canUpgradeAwakenSkill = player.gold >= awakenSkillUpgradeCost.gold && player.ironSand >= awakenSkillUpgradeCost.iron;

         return (
            <div className="flex flex-col h-full bg-slate-900 absolute inset-0 z-50">
                <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0">
                    <button onClick={onBack} className="flex items-center gap-2 text-slate-300 hover:text-white">
                        <ChevronRight className="rotate-180"/> 뒤로가기
                    </button>
                    <h1 className="text-xl font-cinzel text-white hidden sm:block">대원 관리</h1>
                    <div className="flex gap-4 text-sm font-mono items-center">
                        <span className="text-yellow-400">{player.gold.toLocaleString()} G</span>
                        <span className="text-red-400 flex items-center gap-1"><Hammer size={14}/> {player.ironSand.toLocaleString()}</span>
                        <span className="text-blue-400 flex items-center gap-1"><Flower size={14}/> {player.blueLily.toLocaleString()}</span>
                    </div>
                </div>

                <div className="flex-1 flex flex-col md:flex-row overflow-hidden min-h-0">
                    <div className="w-full md:w-1/3 bg-slate-900 border-r border-slate-800 flex flex-col min-h-0 h-1/3 md:h-full">
                        <div className="p-3 flex gap-2 border-b border-slate-800 shrink-0">
                            {['LEVEL', 'RANK', 'ATK'].map(m => (
                                <button key={m} onClick={() => setSortMode(m)} className={`flex-1 text-[10px] py-1 rounded border ${sortMode === m ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-500'}`}>
                                    {m === 'LEVEL' ? '레벨순' : m === 'RANK' ? '계급순' : '공격력순'}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar min-h-0">
                            {sortedSlayers.map(slayer => {
                                const isSelected = slayer.id === selectedSlayerId;
                                const inParty = player.selectedSlayerIds.includes(slayer.id);
                                const isLimitBroken = (slayer.limitBreakLevel || 0) > 0;
                                return (
                                    <div 
                                        key={slayer.id} 
                                        onClick={() => setSelectedSlayerId(slayer.id)}
                                        className={`p-2 rounded border flex items-center gap-3 cursor-pointer transition-all ${isSelected ? 'bg-indigo-900/40 border-indigo-500' : 'bg-slate-800 border-slate-700 hover:bg-slate-700'} ${inParty ? 'border-l-4 border-l-green-500' : ''}`}
                                    >
                                        <div className={`w-12 h-12 rounded-full ${slayer.color} flex items-center justify-center text-white font-bold relative shrink-0 ${isLimitBroken ? 'ring-2 ring-purple-500' : ''}`}>
                                            {slayer.name[0]}
                                            {inParty && <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-slate-800"></div>}
                                        </div>
                                        <div className="overflow-hidden">
                                            <div className="font-bold text-slate-200 text-sm truncate flex gap-1 items-center">
                                                {slayer.name} 
                                                {slayer.role === Role.SUPPORTER && <span className="text-[10px] bg-emerald-900 text-emerald-300 px-1 rounded">SUP</span>}
                                                {isLimitBroken && <span className="text-purple-400 text-[10px]">★{slayer.limitBreakLevel}</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 flex gap-2">
                                                <span>Lv.{slayer.level}</span>
                                                <span className="text-red-400">ATK {slayer.atk}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {selectedSlayer ? (
                        <div className="flex-1 bg-slate-900 p-0 flex flex-col h-2/3 md:h-full min-h-0">
                            <div className="flex border-b border-slate-700 bg-slate-800/50">
                                {['STATUS', 'SKILL', 'EQUIP'].map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${activeTab === tab ? 'border-indigo-500 text-white bg-indigo-900/20' : 'border-transparent text-slate-500 hover:text-slate-300'}`}
                                    >
                                        {tab === 'STATUS' ? '능력치' : tab === 'SKILL' ? '기술' : '장비'}
                                    </button>
                                ))}
                            </div>

                            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                                <div className="flex flex-col md:flex-row gap-6 items-center md:items-start shrink-0 mb-6">
                                    <div className={`w-24 h-24 md:w-32 md:h-32 rounded-xl ${selectedSlayer.color} flex items-center justify-center text-5xl text-white shadow-[0_0_30px_rgba(255,255,255,0.1)] relative group shrink-0 ${selectedSlayer.limitBreakLevel > 0 ? 'aura-limit-break' : ''}`}>
                                        {selectedSlayer.name[0]}
                                        {selectedSlayer.markLevel > 0 && <Flame className="absolute top-1 right-1 text-red-500 animate-pulse" size={20}/>}
                                        {selectedSlayer.limitBreakLevel > 0 && <Crown className="absolute -top-2 -left-2 text-purple-400 drop-shadow-lg" size={24}/>}
                                        {selectedSlayer.role === Role.SUPPORTER && <Shield className="absolute bottom-1 left-1 text-emerald-400" size={20}/>}
                                    </div>
                                    <div className="flex-1 text-center md:text-left w-full">
                                        <h2 className="text-2xl font-bold text-white mb-1 flex items-center justify-center md:justify-start gap-2 flex-wrap">
                                            {selectedSlayer.name} 
                                            <button onClick={() => onToggleSlayer(selectedSlayer.id)} className={`px-3 py-1 rounded-full text-xs border ${player.selectedSlayerIds.includes(selectedSlayer.id) ? 'bg-green-600 border-green-400 text-white' : 'bg-slate-700 border-slate-600 text-slate-400'}`}>
                                                {player.selectedSlayerIds.includes(selectedSlayer.id) ? '출전 중' : '휴식 중'}
                                            </button>
                                        </h2>
                                        <div className="flex gap-2 justify-center md:justify-start mb-1">
                                            <p className="text-indigo-400">{currentRank?.name || '계급 없음'}</p>
                                            {selectedSlayer.role === Role.SUPPORTER && <span className="text-emerald-400 text-xs font-bold border border-emerald-500/50 px-2 rounded">서포터</span>}
                                        </div>
                                        {selectedSlayer.limitBreakLevel > 0 && <p className="text-purple-400 text-xs font-bold animate-pulse">초월 {selectedSlayer.limitBreakLevel}단계 개방됨</p>}
                                    </div>
                                </div>

                                {activeTab === 'STATUS' && (
                                    <div className="space-y-6">
                                         <div className="grid grid-cols-2 gap-4 bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                            <div>
                                                <div className="text-xs text-slate-500">체력</div>
                                                <div className="text-lg font-bold text-green-400">{selectedSlayer.maxHp.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-slate-500">공격력/회복량</div>
                                                <div className="text-lg font-bold text-red-400">{selectedSlayer.atk.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-slate-500">치명타 확률</div>
                                                <div className="text-lg font-bold text-yellow-400">{5 + weaponLv + (player.trainingLevels?.meditation || 0)}%</div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-slate-500">호흡 숙련도</div>
                                                <div className="text-lg font-bold text-blue-400">{selectedSlayer.mastery || 0}</div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                                <div className="flex justify-between mb-2">
                                                    <span className="font-bold text-slate-200">레벨 강화</span>
                                                    <span className="text-xs text-yellow-500">{upgradeCost.toLocaleString()} G</span>
                                                </div>
                                                {selectedSlayer.level >= (100 + (limitLevel * 50)) ? (
                                                     <div className="text-center text-xs text-red-400 py-2 border border-red-900/50 rounded bg-red-900/10">
                                                         최대 레벨 도달<br/>초월이 필요합니다
                                                     </div>
                                                ) : (
                                                    <button 
                                                        onClick={() => onUpgrade(selectedSlayer.id)}
                                                        disabled={!canUpgrade}
                                                        className={`w-full py-2 rounded font-bold text-sm ${canUpgrade ? 'bg-amber-600 hover:bg-amber-500 text-white' : 'bg-slate-700 text-slate-500'}`}
                                                    >
                                                        Lv.{selectedSlayer.level} → Lv.{selectedSlayer.level + 1}
                                                    </button>
                                                )}
                                            </div>

                                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                                <div className="flex justify-between mb-2">
                                                    <span className="font-bold text-slate-200">승급 심사</span>
                                                    {nextRank ? <span className="text-xs text-purple-400">{nextRank.cost.toLocaleString()} G (Lv.{nextRank.minLv})</span> : <span className="text-xs text-slate-500">최고 계급</span>}
                                                </div>
                                                <button 
                                                    onClick={() => onPromote(selectedSlayer.id)}
                                                    disabled={!canPromote}
                                                    className={`w-full py-2 rounded font-bold text-sm ${canPromote ? 'bg-purple-600 hover:bg-purple-500 text-white' : 'bg-slate-700 text-slate-500'}`}
                                                >
                                                    {nextRank ? `${nextRank.name} 승급` : '승급 불가'}
                                                </button>
                                            </div>

                                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 relative overflow-hidden md:col-span-2">
                                                <div className="flex justify-between mb-2 relative z-10">
                                                    <span className="font-bold text-slate-200">반점 발현 (Lv.50)</span>
                                                    <span className="text-xs text-orange-400">100k G / 100 철</span>
                                                </div>
                                                <button 
                                                    onClick={() => onAwakenMark(selectedSlayer.id)}
                                                    disabled={!canAffordMark || !canMark}
                                                    className={`w-full py-2 rounded font-bold text-sm relative z-10 ${canAffordMark && canMark ? 'bg-orange-600 hover:bg-orange-500 text-white animate-pulse' : 'bg-slate-700 text-slate-500'}`}
                                                >
                                                    능력치 50% 영구 상승 (초기화)
                                                </button>
                                                {selectedSlayer.markLevel > 0 && <div className="absolute -bottom-4 -right-4 text-6xl text-red-500/10 font-black z-0 pointer-events-none">{selectedSlayer.markLevel}</div>}
                                            </div>

                                            <div className="bg-slate-900 border-2 border-purple-500/50 p-4 rounded-lg md:col-span-2 relative overflow-hidden">
                                                 <div className="absolute inset-0 bg-purple-900/20"></div>
                                                 <div className="relative z-10">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-bold text-purple-300 flex items-center gap-2"><Crown size={16}/> 한계 돌파 (초월)</span>
                                                        <div className="flex flex-col items-end text-xs">
                                                            <span className={player.blueLily >= limitCost.lily ? 'text-blue-300' : 'text-red-400'}>{limitCost.lily} 피안화</span>
                                                            <span className={player.ironSand >= limitCost.iron ? 'text-slate-300' : 'text-red-400'}>{limitCost.iron} 철</span>
                                                            <span className={player.gold >= limitCost.gold ? 'text-yellow-300' : 'text-red-400'}>{limitCost.gold.toLocaleString()} G</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-slate-400 mb-2">최대 레벨을 50 확장하고 능력치를 대폭 강화합니다. (현재: {limitLevel}/5)</div>
                                                    <button 
                                                        onClick={() => onLimitBreak(selectedSlayer.id)}
                                                        disabled={!canAffordLimit || !canLimitBreak}
                                                        className={`w-full py-3 rounded font-bold text-sm shadow-lg ${canAffordLimit && canLimitBreak ? 'bg-purple-600 hover:bg-purple-500 text-white animate-pulse' : 'bg-slate-800 text-slate-500'}`}
                                                    >
                                                        {limitLevel >= maxLimit ? '최고 단계 도달' : '한계 돌파'}
                                                    </button>
                                                 </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'SKILL' && (
                                    <div className="space-y-4">
                                        <div className="bg-indigo-900/20 p-4 rounded border border-indigo-500/30">
                                            <div className="flex justify-between mb-1 items-center">
                                                <h3 className="font-bold text-indigo-300">기본 기술: {selectedSlayer.skill.name} <span className="text-xs text-white bg-indigo-600 px-1 rounded ml-1">Lv.{skillLv}</span></h3>
                                                <span className="text-xs bg-indigo-900 text-indigo-200 px-2 py-0.5 rounded">쿨타임 {selectedSlayer.skill.cooldown}초</span>
                                            </div>
                                            <p className="text-sm text-slate-400 mb-3">{selectedSlayer.skill.description}</p>
                                            <div className="mt-2 text-xs text-slate-500 mb-3">
                                                {selectedSlayer.role === Role.SUPPORTER 
                                                ? `회복량: 공격력의 ${(1.0 + (skillLv-1)*0.1).toFixed(1)}배` 
                                                : `피해량: 공격력의 ${(selectedSlayer.skill.damageMultiplier + (skillLv-1)*0.1).toFixed(1)}배`}
                                            </div>
                                            
                                            <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded">
                                                <div className="text-xs">
                                                    <span className="text-yellow-500 block">{skillUpgradeCost.gold} G</span>
                                                    <span className="text-red-400 block">{skillUpgradeCost.iron} 철</span>
                                                </div>
                                                <button 
                                                    onClick={() => onUpgradeSkill(selectedSlayer.id, 'BASIC')}
                                                    disabled={!canUpgradeSkill}
                                                    className={`px-3 py-1 rounded text-xs font-bold ${canUpgradeSkill ? 'bg-indigo-600 hover:bg-indigo-500 text-white' : 'bg-slate-700 text-slate-500'}`}
                                                >
                                                    강화 (+Lv.1)
                                                </button>
                                            </div>
                                        </div>

                                        <div className={`p-4 rounded border ${selectedSlayer.level >= 10 ? 'bg-red-900/20 border-red-500/30' : 'bg-slate-800 border-slate-700 opacity-50'}`}>
                                            <div className="flex justify-between mb-1 items-center">
                                                <h3 className="font-bold text-red-300">각성 기술: {selectedSlayer.awakenSkill.name} <span className="text-xs text-white bg-red-600 px-1 rounded ml-1">Lv.{awakenSkillLv}</span></h3>
                                                <span className="text-xs bg-red-900 text-red-200 px-2 py-0.5 rounded">쿨타임 {selectedSlayer.awakenSkill.cooldown}초</span>
                                            </div>
                                            <p className="text-sm text-slate-400 mb-3">{selectedSlayer.awakenSkill.description}</p>
                                            <div className="mt-2 text-xs text-slate-500 mb-3">
                                                {selectedSlayer.role === Role.SUPPORTER 
                                                ? '효과: 아군 전체 대폭 회복/버프' 
                                                : `피해량: 공격력의 ${(selectedSlayer.awakenSkill.damageMultiplier + (awakenSkillLv-1)*0.2).toFixed(1)}배`}
                                            </div>
                                            
                                            {selectedSlayer.level >= 10 ? (
                                                <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded">
                                                    <div className="text-xs">
                                                        <span className="text-yellow-500 block">{awakenSkillUpgradeCost.gold} G</span>
                                                        <span className="text-red-400 block">{awakenSkillUpgradeCost.iron} 철</span>
                                                    </div>
                                                    <button 
                                                        onClick={() => onUpgradeSkill(selectedSlayer.id, 'AWAKEN')}
                                                        disabled={!canUpgradeAwakenSkill}
                                                        className={`px-3 py-1 rounded text-xs font-bold ${canUpgradeAwakenSkill ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-slate-700 text-slate-500'}`}
                                                    >
                                                        강화 (+Lv.1)
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-red-500 text-xs font-bold mt-2">※ 레벨 10 달성 시 해금</div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'EQUIP' && (
                                    <div className="space-y-6">
                                        <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                            <div className="flex justify-between mb-2">
                                                <span className="font-bold text-slate-200 flex items-center gap-2"><Swords size={16}/> 일륜도 연마 (+{weaponLv})</span>
                                                <span className="text-xs text-red-400">{weaponIronCost} 철 / {weaponGoldCost} G</span>
                                            </div>
                                            <p className="text-xs text-slate-400 mb-4">무기를 연마하여 치명타 확률과 피해량을 증가시킵니다.</p>
                                            <button 
                                                onClick={() => onRefineWeapon(selectedSlayer.id)}
                                                disabled={!canRefine}
                                                className={`w-full py-2 rounded font-bold text-sm ${canRefine ? 'bg-red-700 hover:bg-red-600 text-white' : 'bg-slate-700 text-slate-500'}`}
                                            >
                                                연마하기
                                            </button>
                                        </div>

                                        <div className="border-t border-slate-700 pt-6">
                                            <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Backpack size={16}/> 유물 장착</h3>
                                            <div className="bg-slate-900 border border-slate-700 p-4 rounded mb-4 text-center min-h-[100px] flex flex-col items-center justify-center">
                                                {equippedArtifact ? (
                                                    <>
                                                        <div className={`text-lg font-bold mb-1 text-yellow-400`}>{equippedArtifact.name}</div>
                                                        <div className="text-xs text-slate-400 mb-3">{equippedArtifact.desc}</div>
                                                        <button onClick={() => onUnequipArtifact(selectedSlayer.id)} className="text-xs bg-red-900/50 text-red-300 px-3 py-1 rounded hover:bg-red-900">장착 해제</button>
                                                    </>
                                                ) : (
                                                    <div className="text-slate-600 text-sm">장착된 유물이 없습니다.</div>
                                                )}
                                            </div>

                                            <div className="space-y-2">
                                                <div className="text-xs text-slate-400 font-bold mb-2">인벤토리 ({player.inventory.length})</div>
                                                <div className="grid gap-2">
                                                    {player.inventory.map(item => {
                                                        const wearer = player.ownedSlayers.find(s => s.equippedArtifactId === item.id);
                                                        const isEquippedByOther = wearer && wearer.id !== selectedSlayer.id;
                                                        
                                                        if (selectedSlayer.equippedArtifactId === item.id) return null;

                                                        return (
                                                            <div key={item.id} className={`p-3 rounded border bg-slate-800 flex justify-between items-center border-slate-600`}>
                                                                <div>
                                                                    <div className={`text-sm font-bold text-yellow-400`}>{item.name}</div>
                                                                    <div className="text-[10px] text-slate-400">{item.desc}</div>
                                                                    {isEquippedByOther && <div className="text-[10px] text-yellow-600 mt-1">From: {wearer.name}</div>}
                                                                </div>
                                                                <button 
                                                                    onClick={() => onEquipArtifact(selectedSlayer.id, item.id)}
                                                                    className={`px-3 py-1 rounded text-xs font-bold border ${isEquippedByOther ? 'bg-yellow-900/30 border-yellow-600 text-yellow-500' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'}`}
                                                                >
                                                                    {isEquippedByOther ? '뺏어오기' : '장착'}
                                                                </button>
                                                            </div>
                                                        )
                                                    })}
                                                    {player.inventory.length === 0 && <div className="text-center text-xs text-slate-600 py-4">보유한 유물이 없습니다.</div>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 bg-slate-900 flex items-center justify-center text-slate-500">
                            좌측 목록에서 대원을 선택하세요.
                        </div>
                    )}
                </div>
            </div>
         );
      };

      // 1. Estate View (Hub)
      const EstateView = ({ 
        player, 
        onStartPatrol,
        onStartInfinityCastle, 
        onStartRaid,
        onStartDefense, 
        onStartTrain,   
        onStartDistrict,
        onHealAll, 
        onRecruit,
        onToggleSlayer,
        onChangeDifficulty,
        onResetData,
        onBuyShopItem,
        onOpenManagement,
        onTrain
      }) => {
        const [activeTab, setActiveTab] = useState('HQ'); 
        const needsHeal = player.ownedSlayers.some(s => s.currentHp < s.maxHp);
        const selectedCount = player.selectedSlayerIds.length;
        const activeSynergies = getSynergies(player.selectedSlayerIds);

        const enemyListLength = ENEMY_TEMPLATES.length;
        const loopCount = Math.floor((player.stage - 1) / enemyListLength);
        const enemyIndex = (player.stage - 1) % enemyListLength;
        const nextEnemyName = ENEMY_TEMPLATES[enemyIndex].name;
        
        let prefix = "";
        if (loopCount === 1) prefix = "중등 ";
        else if (loopCount === 2) prefix = "상등 ";
        else if (loopCount === 3) prefix = "특등 ";
        else if (loopCount > 3) prefix = `초월(${loopCount-3}) `;

        const raidLocked = loopCount < 3; 

        return (
          <div className="flex flex-col h-full w-full absolute inset-0 bg-[url('https://images.unsplash.com/photo-1599587236720-302787e2213a?q=80&w=1920&auto=format&fit=crop')] bg-cover bg-center overflow-hidden">
            <div className="absolute inset-0 bg-slate-950/90 backdrop-blur-sm"></div>
            
            <div className="relative z-10 p-4 sm:p-6 flex justify-between items-start border-b border-slate-700 bg-slate-900/50 shrink-0">
              <div>
                <h1 className="text-xl sm:text-3xl font-cinzel text-indigo-100 drop-shadow-lg font-bold">귀살대 본부 (Ver 16.2)</h1>
                <p className="text-slate-400 text-xs sm:text-sm mt-1">
                  진행: <span className="text-yellow-400 font-bold">STAGE {player.stage}</span>
                  <span className="ml-2 bg-slate-800 px-2 py-0.5 rounded text-xs text-slate-400">{player.difficulty}</span>
                </p>
              </div>
              <div className="flex flex-col items-end gap-2">
                <div className="flex gap-2">
                    <div className="bg-slate-800 px-3 py-1 rounded-full border border-yellow-600/50 flex items-center gap-2 text-yellow-400 shadow-lg">
                        <span className="text-sm sm:text-xl font-bold">{player.gold.toLocaleString()}</span>
                        <span className="text-xs uppercase tracking-wider">Gold</span>
                    </div>
                    <div className="bg-slate-800 px-3 py-1 rounded-full border border-red-600/50 flex items-center gap-2 text-red-400 shadow-lg">
                        <span className="text-sm sm:text-xl font-bold">{player.ironSand.toLocaleString()}</span>
                        <span className="text-xs tracking-wider">성성철</span>
                    </div>
                    <div className="bg-slate-800 px-3 py-1 rounded-full border border-blue-600/50 flex items-center gap-2 text-blue-400 shadow-lg">
                        <Flower size={16}/>
                        <span className="text-sm sm:text-xl font-bold">{player.blueLily.toLocaleString()}</span>
                    </div>
                </div>
              </div>
            </div>

            <div className="relative z-10 flex gap-2 sm:gap-4 px-4 sm:px-6 pt-4 overflow-x-auto shrink-0 custom-scrollbar pb-2">
                <button onClick={() => setActiveTab('HQ')} className={`whitespace-nowrap px-4 py-2 rounded-t-lg font-bold transition-all flex gap-2 ${activeTab === 'HQ' ? 'bg-slate-800 text-white border-t border-x border-slate-600' : 'bg-slate-900/50 text-slate-500 hover:text-slate-300'}`}>
                    <Home size={18} /> 본부
                </button>
                <button onClick={() => setActiveTab('CAMPAIGN')} className={`whitespace-nowrap px-4 py-2 rounded-t-lg font-bold transition-all flex gap-2 ${activeTab === 'CAMPAIGN' ? 'bg-slate-800 text-white border-t border-x border-slate-600' : 'bg-slate-900/50 text-slate-500 hover:text-slate-300'}`}>
                    <Target size={18} /> 작전 구역
                </button>
                <button onClick={() => setActiveTab('TRAINING')} className={`whitespace-nowrap px-4 py-2 rounded-t-lg font-bold transition-all flex gap-2 ${activeTab === 'TRAINING' ? 'bg-slate-800 text-white border-t border-x border-slate-600' : 'bg-slate-900/50 text-slate-500 hover:text-slate-300'}`}>
                    <Dumbbell size={18} /> 주합 훈련
                </button>
                 <button onClick={() => setActiveTab('RAID')} className={`whitespace-nowrap px-4 py-2 rounded-t-lg font-bold transition-all flex gap-2 ${activeTab === 'RAID' ? 'bg-red-900/80 text-white border-t border-x border-red-600' : 'bg-slate-900/50 text-red-500/70 hover:text-red-400'}`}>
                    <Skull size={18} /> 최종국면 {raidLocked && '🔒'}
                </button>
                <button onClick={() => setActiveTab('SHOP')} className={`whitespace-nowrap px-4 py-2 rounded-t-lg font-bold transition-all flex gap-2 ${activeTab === 'SHOP' ? 'bg-slate-800 text-white border-t border-x border-slate-600' : 'bg-slate-900/50 text-slate-500 hover:text-slate-300'}`}>
                    <ShoppingBag size={18} /> 상점
                </button>
            </div>

            <div className="relative z-10 flex-1 bg-slate-800/90 border-t border-slate-700 p-4 sm:p-6 overflow-hidden min-h-0 flex flex-col">
              
              {activeTab === 'HQ' && (
                  <div className="grid lg:grid-cols-2 gap-6 h-full overflow-y-auto pb-20 custom-scrollbar">
                    <div className="space-y-4">
                        <div className="bg-slate-900/50 rounded-xl p-6 border border-slate-700">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                            <h2 className="text-xl text-slate-200 font-bold">기본 임무</h2>
                            <div className="flex gap-1">
                                {(['EASY', 'NORMAL', 'HARD']).map(d => (
                                    <button key={d} onClick={() => onChangeDifficulty(d)} className={`px-2 py-0.5 text-[10px] rounded border ${player.difficulty === d ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-800 border-slate-600 text-slate-500'}`}>{d}</button>
                                ))}
                            </div>
                        </div>
                        <div className="grid gap-3">
                            <button 
                            onClick={onStartPatrol}
                            disabled={selectedCount === 0}
                            className={`w-full py-4 rounded-lg font-bold text-lg flex items-center justify-center gap-3 shadow-lg transition-all active:scale-95 group border
                                ${selectedCount > 0 
                                ? 'bg-gradient-to-r from-indigo-900 to-indigo-700 hover:from-indigo-800 hover:to-indigo-600 border-indigo-500 text-white' 
                                : 'bg-slate-800 border-slate-600 text-slate-500 cursor-not-allowed'}`}
                            >
                            <Swords size={24} className={selectedCount > 0 ? "group-hover:rotate-12 transition-transform" : ""} /> 
                            {selectedCount > 0 ? `다음 혈귀 토벌 (${prefix}${nextEnemyName})` : '출전할 대원을 선택하세요'}
                            </button>
                            
                            <button 
                            onClick={onHealAll}
                            disabled={!needsHeal}
                            className={`w-full py-3 rounded-lg font-bold flex items-center justify-center gap-3 border transition-all ${needsHeal ? 'bg-emerald-900/80 border-emerald-500 text-emerald-100 hover:bg-emerald-800' : 'bg-slate-800 border-slate-700 text-slate-500 cursor-not-allowed'}`}
                            >
                            <Heart size={20} /> 
                            {needsHeal ? '나비저택 치료 (무료)' : '모두 건강함'}
                            </button>

                            <div className="flex gap-2">
                                <button 
                                    onClick={onOpenManagement}
                                    className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-slate-200 font-bold flex items-center justify-center gap-2 transition-all"
                                >
                                    <Users size={20} /> 
                                    대원 관리
                                </button>
                                <button 
                                    onClick={onRecruit}
                                    className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-slate-200 font-bold flex items-center justify-center gap-2 transition-all"
                                >
                                    <ShoppingBag size={20} /> 
                                    대원 영입
                                </button>
                            </div>
                        </div>
                        </div>

                        <div className="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                            <h2 className="text-sm text-slate-400 mb-2 font-bold flex items-center gap-2">
                                <Users size={16} /> 활성화된 시너지 ({activeSynergies.length})
                            </h2>
                            {activeSynergies.length > 0 ? (
                                <div className="space-y-2">
                                {activeSynergies.map(syn => (
                                    <div key={syn.name} className="p-2 bg-indigo-900/30 border border-indigo-500/30 rounded text-xs">
                                    <span className="font-bold text-indigo-300">{syn.name}:</span> <span className="text-indigo-200">{syn.description}</span>
                                    </div>
                                ))}
                                </div>
                            ) : (
                                <div className="text-slate-600 text-xs italic">시너지가 없습니다.</div>
                            )}
                        </div>
                    </div>

                    <div className="bg-slate-900/50 rounded-xl p-4 border border-slate-700 flex flex-col h-[400px] lg:h-auto overflow-hidden">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                             <h2 className="text-xl text-slate-200 font-bold">출전 대원</h2>
                             <span className={`text-sm font-bold ${selectedCount === 4 ? 'text-red-400' : 'text-slate-400'}`}>
                                {selectedCount}/4
                            </span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar min-h-0">
                        {selectedCount === 0 && <div className="text-center text-slate-500 py-10">대원이 선택되지 않았습니다.<br/>[대원 관리]에서 출전시킬 대원을 선택하세요.</div>}
                        {player.ownedSlayers.filter(s => player.selectedSlayerIds.includes(s.id)).map(slayer => {
                            const equipped = player.inventory.find(i => i.id === slayer.equippedArtifactId);
                            const isLimitBroken = slayer.limitBreakLevel > 0;
                            
                            return (
                            <div key={slayer.id} className={`p-3 rounded-lg border flex items-center gap-4 bg-slate-950 border-slate-800 ${isLimitBroken ? 'border-l-4 border-l-purple-500' : ''}`}>
                                <div className={`w-12 h-12 rounded-full ${slayer.color} flex items-center justify-center text-white font-bold shadow-md shrink-0 relative ${isLimitBroken ? 'ring-2 ring-purple-500' : ''}`}>
                                    {slayer.name.charAt(0)}
                                    {slayer.markLevel > 0 && <span className="absolute -bottom-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-600 text-[8px] font-bold">{slayer.markLevel}</span>}
                                    {isLimitBroken && <Crown size={12} className="absolute -top-1 -left-1 text-purple-400"/>}
                                    {slayer.role === Role.SUPPORTER && <Shield size={12} className="absolute bottom-0 left-0 text-emerald-400 bg-black rounded-full"/>}
                                </div>
                                <div className="flex-1">
                                    <div className="font-bold text-slate-200 text-sm flex gap-1 items-center">
                                        {slayer.name}
                                        {slayer.role === Role.SUPPORTER && <span className="text-[10px] bg-emerald-900 px-1 rounded text-emerald-300">SUP</span>}
                                        {isLimitBroken && <span className="text-[10px] text-purple-400 font-bold">★{slayer.limitBreakLevel}</span>}
                                    </div>
                                    <div className="text-xs text-indigo-400 font-mono">
                                        Lv.{slayer.level} • {slayer.role === Role.SUPPORTER ? 'Heal/Buff' : `ATK ${slayer.atk}`}
                                    </div>
                                </div>
                                <div className="text-right text-xs text-slate-400">
                                    {equipped ? <span className="text-yellow-500 block">★ {equipped.name}</span> : <span className="text-slate-600 block">장비 없음</span>}
                                    <div className={`h-1.5 w-16 bg-slate-800 rounded-full mt-1 overflow-hidden`}>
                                        <div className="bg-green-500 h-full" style={{width: `${(slayer.currentHp/slayer.maxHp)*100}%`}}></div>
                                    </div>
                                </div>
                            </div>
                            );
                        })}
                        </div>
                    </div>
                  </div>
              )}

               {activeTab === 'CAMPAIGN' && (
                  <div className="h-full overflow-y-auto custom-scrollbar p-2">
                       <h2 className="text-2xl font-cinzel text-slate-200 mb-6 text-center">특수 작전 구역</h2>
                       <div className="grid md:grid-cols-2 gap-4 max-w-5xl mx-auto">
                            <div className="bg-purple-900/20 border border-purple-500/30 p-6 rounded-xl relative overflow-hidden group hover:bg-purple-900/30 transition-all">
                                <div className="absolute top-0 right-0 p-4 opacity-20"><Mountain size={100}/></div>
                                <h3 className="text-xl font-bold text-purple-300 mb-2">무한성 (Infinity Castle)</h3>
                                <p className="text-sm text-slate-400 mb-4 h-10">끝없이 이어지는 혈귀들의 소굴. 층수가 높을수록 강력한 적이 등장합니다.</p>
                                <div className="text-xs text-purple-200 mb-4 bg-purple-900/40 inline-block px-2 py-1 rounded">최고 기록: {player.infinityCastleRecord || 0}층</div>
                                <button onClick={onStartInfinityCastle} className="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white rounded font-bold shadow-lg">무한성 진입</button>
                            </div>

                            <div className="bg-orange-900/20 border border-orange-500/30 p-6 rounded-xl relative overflow-hidden group hover:bg-orange-900/30 transition-all">
                                <div className="absolute top-0 right-0 p-4 opacity-20"><Flame size={100}/></div>
                                <h3 className="text-xl font-bold text-orange-300 mb-2">무한열차 (Mugen Train)</h3>
                                <p className="text-sm text-slate-400 mb-4 h-10">체력 회복이 불가능한 극한의 생존 모드. 렌고쿠의 도시락으로 버티세요.</p>
                                <button onClick={onStartTrain} className="w-full py-3 bg-orange-600 hover:bg-orange-500 text-white rounded font-bold shadow-lg">탑승하기</button>
                            </div>

                            <div className="bg-blue-900/20 border border-blue-500/30 p-6 rounded-xl relative overflow-hidden group hover:bg-blue-900/30 transition-all">
                                <div className="absolute top-0 right-0 p-4 opacity-20"><Hammer size={100}/></div>
                                <h3 className="text-xl font-bold text-blue-300 mb-2">도공 마을 방어전</h3>
                                <p className="text-sm text-slate-400 mb-4 h-10">'요리이치 영식' 인형을 혈귀들로부터 지켜야 합니다. 보상: 성성철</p>
                                <button onClick={onStartDefense} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg">방어 시작</button>
                            </div>

                            <div className="bg-pink-900/20 border border-pink-500/30 p-6 rounded-xl relative overflow-hidden group hover:bg-pink-900/30 transition-all">
                                <div className="absolute top-0 right-0 p-4 opacity-20"><Droplets size={100}/></div>
                                <h3 className="text-xl font-bold text-pink-300 mb-2">유곽 탈환전 (District)</h3>
                                <p className="text-sm text-slate-400 mb-4 h-10">맹독이 퍼진 전장. 매 턴 아군 전체가 지속 피해를 입습니다.</p>
                                <button onClick={onStartDistrict} className="w-full py-3 bg-pink-600 hover:bg-pink-500 text-white rounded font-bold shadow-lg">잠입하기</button>
                            </div>
                       </div>
                  </div>
               )}

               {activeTab === 'TRAINING' && (
                  <div className="h-full overflow-y-auto custom-scrollbar">
                      <div className="mb-6 text-center">
                          <h2 className="text-2xl font-cinzel text-amber-300 mb-1">주합 훈련</h2>
                          <p className="text-slate-400 text-sm">전체 대원의 능력치를 영구적으로 강화합니다.</p>
                      </div>
                      
                      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto pb-10">
                        {TRAINING_TYPES.map(t => {
                            const currentLv = player.trainingLevels?.[t.id] || 0;
                            const cost = Math.floor(t.costBase * Math.pow(t.costScale, currentLv));
                            const effectVal = t.stat === 'cooldown' ? currentLv : Math.floor((currentLv * t.val) * 100);
                            const canAfford = player.gold >= cost;
                            const unit = t.stat === 'cooldown' ? '%' : '%';
                            
                            return (
                                <div key={t.id} className="bg-slate-900 border border-slate-700 p-6 rounded-xl flex flex-col items-center text-center hover:border-amber-700 transition-colors">
                                    <div className="w-16 h-16 bg-amber-900/30 rounded-full flex items-center justify-center text-amber-500 mb-4 border border-amber-500/30">
                                        {t.icon}
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-200">{t.name}</h3>
                                    <p className="text-xs text-slate-500 mb-4">{t.desc}</p>
                                    
                                    <div className="w-full bg-slate-800 rounded p-2 mb-4">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-400">현재 레벨</span>
                                            <span className="font-bold text-white">Lv.{currentLv}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-400">효과</span>
                                            <span className="font-bold text-green-400">+{effectVal}{unit}</span>
                                        </div>
                                    </div>

                                    <button 
                                        onClick={() => onTrain(t.id)}
                                        disabled={!canAfford}
                                        className={`w-full py-2 rounded font-bold text-sm ${canAfford ? 'bg-amber-700 hover:bg-amber-600 text-white' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}
                                    >
                                        훈련하기 ({cost.toLocaleString()} G)
                                    </button>
                                </div>
                            )
                        })}
                      </div>
                  </div>
              )}

             {activeTab === 'RAID' && (
                  <div className="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto">
                      <div className="relative">
                          <Skull size={80} className={`mb-4 ${raidLocked ? 'text-slate-700' : 'text-red-600 animate-pulse'}`} />
                          {!raidLocked && <div className="absolute inset-0 bg-red-600/30 blur-2xl rounded-full"></div>}
                      </div>
                      <h2 className="text-4xl font-cinzel text-red-500 mb-2 font-bold drop-shadow-md">최종 국면 (Final Battle)</h2>
                      
                      {raidLocked ? (
                          <div className="bg-black/50 p-6 rounded-xl border border-slate-700 mt-4">
                              <ShieldAlert className="mx-auto text-red-500 mb-2" size={32}/>
                              <h3 className="text-xl font-bold text-slate-200">입장 불가</h3>
                              <p className="text-slate-400 mt-2">
                                  아직 무잔에게 도전할 자격이 없습니다.<br/>
                                  <span className="text-yellow-400">특등 난이도(Loop 3)</span> 이상의 오니를 토벌하십시오.
                              </p>
                          </div>
                      ) : (
                          <>
                            <p className="text-slate-300 mb-6 max-w-md">
                                키부츠지 무잔과의 최종 결전입니다.<br/>
                                무잔은 쓰러지지 않지만, 입힌 피해량에 따라 <span className="text-blue-400 font-bold">푸른 피안화</span>를 획득합니다.
                            </p>
                            
                            <div className="grid grid-cols-2 gap-4 w-full mb-8">
                                <div className="bg-red-950/40 border border-red-800/50 p-4 rounded-xl">
                                    <div className="text-red-400 text-xs uppercase mb-1">Target</div>
                                    <div className="font-bold text-lg">키부츠지 무잔 (최종)</div>
                                </div>
                                <div className="bg-blue-950/40 border border-blue-800/50 p-4 rounded-xl">
                                    <div className="text-blue-400 text-xs uppercase mb-1">Reward</div>
                                    <div className="font-bold text-lg">푸른 피안화 (1만딜/1개)</div>
                                </div>
                            </div>

                            <button 
                                onClick={onStartRaid}
                                disabled={selectedCount === 0}
                                className={`w-full py-4 rounded-lg font-bold text-xl flex items-center justify-center gap-3 shadow-[0_0_30px_rgba(220,38,38,0.5)] transition-all active:scale-95 border
                                    ${selectedCount > 0 
                                    ? 'bg-red-700 hover:bg-red-600 border-red-500 text-white' 
                                    : 'bg-slate-800 border-slate-600 text-slate-500 cursor-not-allowed'}`}
                            >
                                {selectedCount > 0 ? '레이드 시작' : '대원을 선택하세요'}
                            </button>
                          </>
                      )}
                  </div>
              )}

              {activeTab === 'SHOP' && (
                  <div className="h-full flex flex-col max-w-5xl mx-auto overflow-y-auto custom-scrollbar">
                      <div className="mb-6 text-center">
                          <h2 className="text-2xl font-cinzel text-blue-300 mb-1">피안화 교환소</h2>
                          <p className="text-slate-400 text-sm">희귀한 재화를 교환하거나 소환을 진행할 수 있습니다.</p>
                      </div>
                      
                      <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 pb-10">
                          <div className="bg-slate-900/80 border border-slate-700 p-4 rounded-xl flex flex-col gap-2">
                              <div className="h-24 bg-yellow-900/30 rounded flex items-center justify-center mb-2 border border-yellow-500/20">
                                  <Backpack size={40} className="text-yellow-400" />
                              </div>
                              <h3 className="font-bold text-slate-200">보급 유물 상자</h3>
                              <p className="text-xs text-slate-400 h-8">골드를 사용하여 유물을 뽑습니다. (일반~영웅)</p>
                              <button onClick={() => onBuyShopItem('ARTIFACT_GACHA_GOLD', 50000)} className="mt-auto py-2 bg-yellow-900/50 border border-yellow-500/50 hover:bg-yellow-800 text-yellow-200 rounded text-sm font-bold flex items-center justify-center gap-1">
                                  50,000 G
                              </button>
                          </div>

                          <div className="bg-slate-900/80 border border-slate-700 p-4 rounded-xl flex flex-col gap-2">
                              <div className="h-24 bg-purple-900/30 rounded flex items-center justify-center mb-2 border border-purple-500/20">
                                  <Gem size={40} className="text-purple-400" />
                              </div>
                              <h3 className="font-bold text-slate-200">전설 유물 상자</h3>
                              <p className="text-xs text-slate-400 h-8">전설 등급 유물을 얻을 수 있는 기회!</p>
                              <button onClick={() => onBuyShopItem('LEGENDARY_BOX', 500)} className="mt-auto py-2 bg-blue-900/50 border border-blue-500/50 hover:bg-blue-800 text-blue-200 rounded text-sm font-bold flex items-center justify-center gap-1">
                                  <Flower size={14} /> 500
                              </button>
                          </div>
                           <div className="bg-slate-900/80 border border-slate-700 p-4 rounded-xl flex flex-col gap-2">
                              <div className="h-24 bg-red-900/30 rounded flex items-center justify-center mb-2 border border-red-500/20">
                                  <Hammer size={40} className="text-red-400" />
                              </div>
                              <h3 className="font-bold text-slate-200">성성철 꾸러미</h3>
                              <p className="text-xs text-slate-400 h-8">성성철 500개를 획득합니다.</p>
                              <button onClick={() => onBuyShopItem('IRON_BUNDLE', 100)} className="mt-auto py-2 bg-blue-900/50 border border-blue-500/50 hover:bg-blue-800 text-blue-200 rounded text-sm font-bold flex items-center justify-center gap-1">
                                  <Flower size={14} /> 100
                              </button>
                          </div>
                          <div className="bg-slate-900/80 border border-slate-700 p-4 rounded-xl flex flex-col gap-2">
                              <div className="h-24 bg-yellow-900/30 rounded flex items-center justify-center mb-2 border border-yellow-500/20">
                                  <div className="text-3xl font-bold text-yellow-500">GOLD</div>
                              </div>
                              <h3 className="font-bold text-slate-200">자금 지원</h3>
                              <p className="text-xs text-slate-400 h-8">1,000,000 골드를 획득합니다.</p>
                              <button onClick={() => onBuyShopItem('GOLD_BUNDLE', 50)} className="mt-auto py-2 bg-blue-900/50 border border-blue-500/50 hover:bg-blue-800 text-blue-200 rounded text-sm font-bold flex items-center justify-center gap-1">
                                  <Flower size={14} /> 50
                              </button>
                          </div>
                      </div>
                  </div>
              )}

            </div>
             <div className="absolute bottom-4 right-4 z-20">
                <button onClick={onResetData} className="text-xs text-slate-600 hover:text-red-500 bg-black/20 px-2 py-1 rounded">데이터 초기화</button>
           </div>
          </div>
        );
      };

      // 2. Battle View
      const BattleView = ({ 
        player, 
        enemy, 
        mode,
        floor,
        raidScore,
        dollHp,
        dollMaxHp,
        onSkillUse, 
        onAwakenSkillUse,
        onRetreat,
        battleLog,
        battleStats
      }) => {
        const logEndRef = useRef(null);
        const [effects, setEffects] = useState([]);
        const [enemySkillEffect, setEnemySkillEffect] = useState(null);
        const [showStats, setShowStats] = useState(false);
        const [isAuto, setIsAuto] = useState(false);
        
        const party = player.ownedSlayers.filter(s => player.selectedSlayerIds.includes(s.id));
        const synergies = getSynergies(player.selectedSlayerIds);

        useEffect(() => {
            if (!isAuto || !enemy || enemy.currentHp <= 0 && mode !== 'RAID') return;
            const interval = setInterval(() => {
                party.forEach(s => {
                    const now = Date.now();
                    const isDead = s.currentHp <= 0;
                    if (isDead) return;

                    const isAwakened = s.level >= 10;
                    if (isAwakened && now >= s.awakenSkillReadyAt) {
                         onAwakenSkillUse(s.id);
                    } else if (now >= s.skillReadyAt) {
                        onSkillUse(s.id);
                    }
                });
            }, 500);
            return () => clearInterval(interval);
        }, [isAuto, party, enemy]);

        useEffect(() => {
          logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [battleLog]);

        useEffect(() => {
          const lastLog = battleLog[battleLog.length - 1];
          if (!lastLog) return;
          
          if (lastLog.includes('!')) {
              const parts = lastLog.split('의 ');
              if (parts.length > 1) {
                  const name = parts[0];
                  const slayer = party.find(s => s.name === name);
                  if (slayer) {
                      const isUltimate = lastLog.includes(slayer.awakenSkill.name);
                      const skillName = isUltimate ? slayer.awakenSkill.name : slayer.skill.name;
                      const isCrit = lastLog.includes('치명타');

                      const newEffect = {
                          id: Date.now(),
                          text: skillName,
                          color: slayer.color,
                          isUltimate,
                          isCrit
                      };
                      setEffects(prev => [...prev, newEffect]);
                      setTimeout(() => {
                          setEffects(prev => prev.filter(e => e.id !== newEffect.id));
                      }, 1500);
                  }
              }
          }
          
          if (lastLog.includes('혈귀술:')) {
             setEnemySkillEffect(enemy.name);
             setTimeout(() => setEnemySkillEffect(null), 1000);
          }
          
        }, [battleLog]);

        return (
          <div className={`flex flex-col h-full bg-slate-950 relative overflow-hidden absolute inset-0 z-50 ${enemySkillEffect ? 'animate-shake' : ''}`}>
            {enemySkillEffect && (
                <div className="absolute inset-0 bg-red-900/30 z-40 pointer-events-none flex items-center justify-center">
                    <div className="text-4xl font-cinzel font-bold text-red-500 drop-shadow-[0_0_10px_rgba(255,0,0,1)]">
                        혈귀술 발동!
                    </div>
                </div>
            )}

            <div className="absolute inset-0 pointer-events-none z-50 flex items-center justify-center">
              {effects.map(effect => (
                  <div key={effect.id} className="absolute flex flex-col items-center animate-bounce-up">
                      <div className={`
                          font-cinzel font-bold text-white px-6 py-2 rounded-lg backdrop-blur-md
                          ${effect.isUltimate 
                            ? 'text-4xl border-2 border-yellow-400 bg-red-900/60 shadow-[0_0_20px_rgba(255,0,0,0.5)]' 
                            : 'text-2xl border border-white/20 bg-black/50'}
                      `}>
                          {effect.text}
                      </div>
                      {effect.isCrit && <div className="text-yellow-400 font-bold text-xl mt-1 animate-pulse">CRITICAL!</div>}
                  </div>
              ))}
            </div>

            <div className="p-4 bg-black/60 backdrop-blur-md border-b border-red-900/30 flex justify-center items-center z-10 relative flex-col shrink-0">
              <div className="w-full max-w-2xl text-center">
                 {mode === 'CASTLE' && <div className="text-purple-400 font-bold mb-1">무한성 {floor}층</div>}
                 {mode === 'TRAIN' && <div className="text-orange-400 font-bold mb-1">무한열차 {floor}칸</div>}
                 {mode === 'DISTRICT' && <div className="text-pink-400 font-bold mb-1">유곽 탈환 작전 (맹독)</div>}
                 {mode === 'RAID' && <div className="text-red-500 font-bold mb-1 animate-pulse">레이드 진행 중 (Total Dmg: {raidScore.toLocaleString()})</div>}
                
                <h2 className={`text-2xl font-bold mb-2 flex items-center justify-center gap-2 ${enemy.isBoss ? 'text-red-500 drop-shadow-[0_0_8px_rgba(220,38,38,0.8)]' : 'text-slate-300'}`}>
                  <Skull size={24} /> {enemy.name} 
                  <span className="text-sm px-2 py-0.5 rounded bg-slate-800 text-slate-400">Lv.{mode === 'RAID' ? '???' : player.stage}</span>
                </h2>
                <ProgressBar current={enemy.currentHp} max={enemy.maxHp} colorClass="bg-red-600" height="h-6" label={mode === 'RAID' ? '불멸 (Immortal)' : `${enemy.currentHp} / ${enemy.maxHp}`}/>
              </div>
            </div>

            {mode === 'DEFENSE' && (
                <div className="absolute top-20 left-4 z-40 bg-slate-900/80 p-3 rounded border border-blue-500/50">
                    <div className="text-xs text-blue-300 font-bold mb-1 flex items-center gap-1"><Shield size={12}/> 방어 대상: 요리이치 영식</div>
                    <div className="w-32 h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div className="bg-blue-500 h-full" style={{width: `${(dollHp/dollMaxHp)*100}%`}}></div>
                    </div>
                    <div className="text-xs text-center mt-1">{dollHp} / {dollMaxHp}</div>
                </div>
            )}

             <div className="absolute top-4 right-4 z-50 flex gap-2">
                <button onClick={() => setIsAuto(!isAuto)} className={`p-2 rounded border font-bold flex items-center gap-2 ${isAuto ? 'bg-green-600 border-green-400 text-white animate-pulse' : 'bg-slate-800 border-slate-600 text-slate-400'}`}>
                    {isAuto ? <PauseCircle size={20}/> : <PlayCircle size={20}/>} AUTO
                </button>
                <button onClick={() => setShowStats(!showStats)} className="bg-black/50 p-2 rounded text-slate-300 hover:text-white border border-slate-700">
                    <BarChart2 size={20}/>
                </button>
             </div>

             {showStats && (
                 <div className="absolute inset-0 z-40 bg-black/80 flex items-center justify-center p-4">
                     <div className="bg-slate-900 border border-slate-700 p-6 rounded-xl max-w-lg w-full">
                         <h3 className="text-xl font-bold text-slate-200 mb-4 flex items-center gap-2"><BarChart2/> 전투 통계</h3>
                         <div className="space-y-3">
                             {party.map(s => {
                                 const dmg = battleStats[s.id] || 0;
                                 const total = Object.values(battleStats).reduce((a,b)=>a+b,0) || 1;
                                 const pct = Math.floor((dmg/total)*100);
                                 return (
                                     <div key={s.id} className="space-y-1">
                                         <div className="flex justify-between text-xs text-slate-300">
                                             <span>{s.name}</span>
                                             <span>{dmg.toLocaleString()} ({pct}%)</span>
                                         </div>
                                         <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                                             <div className={`h-full ${s.color}`} style={{width: `${pct}%`}}></div>
                                         </div>
                                     </div>
                                 )
                             })}
                         </div>
                         <button onClick={() => setShowStats(false)} className="mt-6 w-full py-2 bg-slate-800 border border-slate-600 text-slate-300 rounded hover:bg-slate-700">닫기</button>
                     </div>
                 </div>
             )}

            <div className="flex-1 flex flex-col items-center justify-center relative p-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black min-h-0">
              <div className={`transition-all duration-300 transform ${enemy.currentHp <= 0 && mode !== 'RAID' ? 'scale-90 opacity-0 blur-xl' : 'scale-100 opacity-100'}`}>
                <div className={`w-48 h-48 md:w-64 md:h-64 rounded-full bg-black border-4 ${enemy.isBoss ? 'border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.4)]' : 'border-slate-600'} flex items-center justify-center relative overflow-hidden`}>
                  <Skull size={100} className={`${enemy.imageColor} animate-pulse relative z-10`} />
                  {enemy.isBoss && <div className="absolute inset-0 bg-red-900/20 animate-pulse"></div>}
                </div>
              </div>
              
              <div className="absolute bottom-4 left-0 right-0 flex justify-center gap-2 flex-wrap px-4 pointer-events-none">
                {synergies.map(s => (
                  <div key={s.name} className="bg-indigo-900/60 border border-indigo-400/30 text-indigo-200 text-xs px-2 py-1 rounded backdrop-blur-sm">
                    ⚡ {s.name}
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-slate-900 border-t border-slate-800 p-4 pb-8 z-10 shrink-0">
              <div className="max-w-5xl mx-auto">
                
                <div className="h-20 overflow-y-auto mb-4 bg-black/40 rounded p-2 text-xs font-mono text-slate-400 border border-slate-800/50 custom-scrollbar">
                  {battleLog.map((log, i) => (
                    <div key={i} className={`mb-1 ${log.includes('혈귀술') ? 'text-red-400 font-bold' : log.includes('획득') ? 'text-yellow-400' : ''}`}>{log}</div>
                  ))}
                  <div ref={logEndRef} />
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  {party.map(slayer => {
                    const isDead = slayer.currentHp <= 0;
                    const now = Date.now();
                    const cooldownRemaining = Math.max(0, Math.ceil((slayer.skillReadyAt - now) / 1000));
                    const isReady = cooldownRemaining === 0;

                    const awakenCooldownRemaining = Math.max(0, Math.ceil((slayer.awakenSkillReadyAt - now) / 1000));
                    const isAwakenReady = awakenCooldownRemaining === 0;
                    const isAwakened = slayer.level >= 10; 
                    const isLimitBroken = slayer.limitBreakLevel > 0;
                    const isSupporter = slayer.role === Role.SUPPORTER;

                    return (
                      <div 
                        key={slayer.id} 
                        className={`relative p-2 rounded-lg border transition-all ${isDead ? 'bg-red-900/20 border-red-900 grayscale opacity-70' : 'bg-slate-800 border-slate-700'} ${slayer.markLevel > 0 ? 'border-red-500/50' : ''} ${isLimitBroken ? 'ring-1 ring-purple-500' : ''}`}
                      >
                        <div className="flex justify-between items-start mb-2">
                          <div className="text-xs font-bold text-slate-300 truncate flex items-center gap-1">
                              {slayer.name}
                              {isSupporter && <Shield size={10} className="text-emerald-400"/>}
                              {slayer.markLevel > 0 && <Flame size={10} className="text-red-500" />}
                          </div>
                          <div className="text-[10px] text-slate-500">Lv.{slayer.level}</div>
                        </div>
                        
                        <div className="mb-2">
                          <div className="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                            <div className="bg-green-500 h-full transition-all" style={{ width: `${(slayer.currentHp / slayer.maxHp) * 100}%` }}></div>
                          </div>
                        </div>

                        <div className="flex gap-1">
                          <button
                              onClick={() => !isDead && isReady && onSkillUse(slayer.id)}
                              disabled={isDead || !isReady}
                              className={`flex-1 py-2 rounded text-[10px] font-bold transition-all relative overflow-hidden group ${
                              isDead ? 'bg-slate-800 text-slate-600' :
                              isReady 
                                  ? (isSupporter ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-indigo-600 hover:bg-indigo-500 text-white') 
                                  : 'bg-slate-700 text-slate-400 border border-slate-600 cursor-not-allowed'
                              }`}
                          >
                              {isDead ? 'X' : isReady ? (isSupporter ? '치료' : '기술') : `${cooldownRemaining}s`}
                              {!isReady && !isDead && (
                              <div 
                                  className="absolute inset-0 bg-black/20 origin-left"
                                  style={{ width: `${(cooldownRemaining / slayer.skill.cooldown) * 100}%` }}
                              ></div>
                              )}
                          </button>

                          {isAwakened && (
                              <button
                                  onClick={() => !isDead && isAwakenReady && onAwakenSkillUse(slayer.id)}
                                  disabled={isDead || !isAwakenReady}
                                  className={`flex-1 py-2 rounded text-[10px] font-bold transition-all relative overflow-hidden group ${
                                  isDead ? 'bg-slate-800 text-slate-600' :
                                  isAwakenReady 
                                      ? 'bg-red-600 hover:bg-red-500 text-white shadow-[0_0_10px_rgba(220,38,38,0.5)] border border-red-400' 
                                      : 'bg-slate-700 text-slate-400 border border-slate-600 cursor-not-allowed'
                              }`}
                          >
                              {isDead ? 'X' : isAwakenReady ? '각성' : `${awakenCooldownRemaining}s`}
                              {!isAwakenReady && !isDead && (
                              <div 
                                  className="absolute inset-0 bg-black/20 origin-left"
                                  style={{ width: `${(awakenCooldownRemaining / slayer.awakenSkill.cooldown) * 100}%` }}
                              ></div>
                              )}
                          </button>
                          )}
                          {!isAwakened && (
                              <div className="flex-1 flex items-center justify-center bg-black/20 rounded border border-slate-800">
                                  <span className="text-[9px] text-slate-600">Lv.10 필요</span>
                              </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                  
                  {[...Array(4 - party.length)].map((_, i) => (
                      <div key={`empty-${i}`} className="p-2 rounded-lg border border-slate-800 bg-slate-900/50 flex items-center justify-center opacity-30">
                          <span className="text-xs text-slate-500">빈 슬롯</span>
                      </div>
                  ))}
                </div>

                <button 
                  onClick={onRetreat} 
                  className="mt-4 w-full py-2 text-slate-500 text-sm hover:text-red-400 transition-colors"
                >
                  작전 포기 / 보상 수령 (Estate로 복귀)
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 3. Recruit View
      const RecruitView = ({ 
        player, 
        onBuy, 
        onBack 
      }) => {
        return (
          <div className="flex flex-col h-full bg-slate-900 absolute inset-0 z-50">
            <div className="p-4 border-b border-slate-700 bg-slate-800 flex items-center justify-between shrink-0">
              <button onClick={onBack} className="flex items-center text-slate-300 hover:text-white">
                <ChevronRight className="rotate-180" /> 돌아가기
              </button>
              <h1 className="text-xl font-cinzel text-white">대원 모집</h1>
              <div className="flex gap-2 items-center">
                  <span className="text-yellow-400 font-mono text-sm">{player.gold.toLocaleString()} G</span>
                  <span className="text-blue-400 font-mono text-sm flex items-center gap-1"><Flower size={14}/>{player.blueLily.toLocaleString()}</span>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4 pb-20 custom-scrollbar min-h-0">
              {SLAYERS_DATA.map(slayer => {
                const isOwned = player.ownedSlayers.some(s => s.id === slayer.id);
                const currencyType = slayer.currency || 'GOLD';
                const price = currencyType === 'LILY' ? slayer.lilyPrice : slayer.price;
                const userBalance = currencyType === 'LILY' ? player.blueLily : player.gold;
                const canAfford = userBalance >= price;

                return (
                  <div key={slayer.id} className={`p-4 rounded-xl border flex gap-4 ${isOwned ? 'bg-slate-800/50 border-slate-700 opacity-50' : 'bg-slate-800 border-slate-600'}`}>
                    <div className={`w-16 h-16 rounded-full shrink-0 ${slayer.color} flex items-center justify-center text-2xl font-bold text-white shadow-lg relative`}>
                      {slayer.name.charAt(0)}
                      {slayer.role === Role.SUPPORTER && <Shield size={16} className="absolute bottom-0 right-0 bg-black rounded-full text-emerald-400"/>}
                    </div>
                    <div className="flex-1">
                      <div className="flex justify-between items-start">
                        <h3 className="font-bold text-slate-200">{slayer.name}</h3>
                        {isOwned ? (
                          <span className="text-xs bg-slate-700 px-2 py-1 rounded text-slate-400">보유중</span>
                        ) : (
                          <span className={`${currencyType === 'LILY' ? 'text-blue-400' : 'text-yellow-400'} font-mono font-bold flex items-center gap-1`}>
                              {currencyType === 'LILY' && <Flower size={14}/>}
                              {price === 0 ? '무료' : `${price} ${currencyType === 'LILY' ? '' : 'G'}`}
                          </span>
                        )}
                      </div>
                      <div className="flex gap-2 text-xs mb-1">
                          <span className="text-indigo-400">{slayer.style}</span>
                          {slayer.role === Role.SUPPORTER && <span className="text-emerald-400 font-bold">서포터</span>}
                      </div>
                      <p className="text-xs text-slate-400 mb-2">{slayer.description}</p>
                      
                      {!isOwned && (
                        <button 
                          onClick={() => onBuy(slayer.id)}
                          disabled={!canAfford}
                          className={`mt-3 w-full py-2 rounded text-sm font-bold transition-all ${canAfford ? 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                        >
                          영입하기
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };


      const App = () => {
        const [view, setView] = useState('ESTATE');
        const [battleMode, setBattleMode] = useState('NORMAL');
        const [castleFloor, setCastleFloor] = useState(1);
        const [raidScore, setRaidScore] = useState(0);
        const [battleStats, setBattleStats] = useState({});
        const [dollHp, setDollHp] = useState(10000);
        const [dollMaxHp, setDollMaxHp] = useState(10000);

        const loadSaveData = () => {
             const master = localStorage.getItem(MASTER_SAVE_KEY);
             const v1 = localStorage.getItem(V1_SAVE_KEY);
             
             if (master) return JSON.parse(master);
             if (v1) {
                 const parsed = JSON.parse(v1);
                 // Migrate v1 data to new structure if needed
                 return {
                    gold: parsed.gold ?? 0,
                    ironSand: 0,
                    blueLily: 0,
                    stage: parsed.stage ?? 1,
                    difficulty: parsed.difficulty ?? 'NORMAL',
                    infinityCastleRecord: 0,
                    ownedSlayers: parsed.ownedSlayers ?? [],
                    selectedSlayerIds: parsed.selectedSlayerIds ?? [],
                    inventory: [],
                    trainingLevels: {}
                 }
             }
             return null;
        };

        const [player, setPlayer] = useState(() => {
          try {
            const loaded = loadSaveData();
            if (loaded) {
              return {
                  gold: loaded.gold ?? 0,
                  ironSand: loaded.ironSand ?? 0, 
                  blueLily: loaded.blueLily ?? 0,
                  stage: loaded.stage ?? 1,
                  difficulty: loaded.difficulty ?? 'NORMAL',
                  infinityCastleRecord: loaded.infinityCastleRecord ?? 0,
                  ownedSlayers: loaded.ownedSlayers ?? [],
                  selectedSlayerIds: loaded.selectedSlayerIds ?? [],
                  inventory: loaded.inventory ?? [],
                  trainingLevels: loaded.trainingLevels ?? {}
              };
            }
          } catch (err) {}
          return {
            gold: 0, ironSand: 0, blueLily: 0, stage: 1, difficulty: 'NORMAL',
            infinityCastleRecord: 0, ownedSlayers: [], selectedSlayerIds: [], inventory: [], trainingLevels: {}
          };
        });
        
        useEffect(() => {
          localStorage.setItem(MASTER_SAVE_KEY, JSON.stringify(player));
        }, [player]);

        useEffect(() => {
          if (player.ownedSlayers.length === 0) {
            const tanjiro = SLAYERS_DATA.find(s => s.id === 'tanjiro');
            setPlayer(p => ({
              ...p,
              ownedSlayers: [{
                ...tanjiro,
                level: 1, rankIdx: 0, weaponLevel: 0, markLevel: 0, limitBreakLevel: 0, mastery: 0, 
                currentHp: tanjiro.baseHp, maxHp: tanjiro.baseHp, atk: tanjiro.baseAtk,
                skillReadyAt: 0, awakenSkillReadyAt: 0, equippedArtifactId: null,
                skillLevel: 1, awakenSkillLevel: 1
              }],
              selectedSlayerIds: ['tanjiro']
            }));
          }
        }, [player.ownedSlayers.length]);

        const resetGameData = () => {
            if(window.confirm("정말로 모든 데이터를 초기화하시겠습니까? (복구 불가)")) {
                localStorage.removeItem(MASTER_SAVE_KEY);
                window.location.reload();
            }
        };

        const [enemy, setEnemy] = useState(null);
        const [battleLog, setBattleLog] = useState([]);
        const battleIntervalRef = useRef(null);

        const addLog = (msg) => {
          setBattleLog(prev => [...prev.slice(-4), msg]);
        };
        
        const changeDifficulty = (diff) => {
            setPlayer(prev => ({ ...prev, difficulty: diff }));
        };

        const toggleSlayerSelection = (slayerId) => {
            setPlayer(prev => {
                const isSelected = prev.selectedSlayerIds.includes(slayerId);
                if (isSelected) {
                    return { ...prev, selectedSlayerIds: prev.selectedSlayerIds.filter(id => id !== slayerId) };
                } else {
                    if (prev.selectedSlayerIds.length >= 4) return prev;
                    return { ...prev, selectedSlayerIds: [...prev.selectedSlayerIds, slayerId] };
                }
            });
        };

        const resetCooldowns = (slayers) => {
             return slayers.map(s => ({ ...s, skillReadyAt: 0, awakenSkillReadyAt: 0 }));
        };

        const finishRaid = () => {
             if (battleMode !== 'RAID') return;
             
             // Calculate Reward: 1 Blue Lily per 10,000 Damage (Significantly increased)
             const lilyReward = Math.floor(raidScore / 10000);
             const goldReward = Math.floor(raidScore / 10);
             
             setPlayer(p => ({
                 ...p,
                 blueLily: p.blueLily + lilyReward,
                 gold: p.gold + goldReward
             }));
             
             if (lilyReward > 0) alert(`[최종 국면 보상] 푸른 피안화 ${lilyReward}개, ${goldReward.toLocaleString()}G 획득!`);
             else alert(`[최종 국면 종료] ${goldReward.toLocaleString()}G 획득. (피안화는 1만점 당 1개)`);
             
             setEnemy(null);
             setView('ESTATE');
        };

        const startPatrol = () => {
          setBattleMode('NORMAL');
          setBattleStats({});
          setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));

          const enemyListLength = ENEMY_TEMPLATES.length;
          const loopCount = Math.floor((player.stage - 1) / enemyListLength);
          const enemyIndex = (player.stage - 1) % enemyListLength;
          const template = ENEMY_TEMPLATES[enemyIndex];
          
          let loopMult = 1.0 + (Math.max(0, loopCount) * 1.5);
          const diffScaling = getDifficultyMultiplier(player.difficulty);
          const finalMultiplier = loopMult * diffScaling;
          
          let prefix = "";
          if (loopCount === 1) prefix = "중등 ";
          else if (loopCount === 2) prefix = "상등 ";
          else if (loopCount === 3) prefix = "특등 ";
          else if (loopCount > 3) prefix = `초월(${loopCount-3}) `;

          const newEnemy = {
            id: Math.random().toString(),
            name: `${prefix}${template.name}`,
            maxHp: Math.floor((template.maxHp || 100) * finalMultiplier),
            currentHp: Math.floor((template.maxHp || 100) * finalMultiplier),
            atk: Math.floor((template.atk || 10) * finalMultiplier),
            rewardGold: Math.floor((template.rewardGold || 50) * finalMultiplier * getRewardMultiplier(player.difficulty)),
            isBoss: template.isBoss || false,
            imageColor: template.imageColor || 'text-gray-500',
            skillProb: template.skillProb || 0,
            skillName: template.skillName,
            skillDmgMult: template.skillDmgMult || 1.0
          };

          setEnemy(newEnemy);
          setBattleLog([`STAGE ${player.stage} - ${newEnemy.name} 발견!`]);
          setView('BATTLE');
        };

        const startInfinityCastle = () => {
            setBattleMode('CASTLE');
            setCastleFloor(1);
            setBattleStats({}); 
            setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));
            generateCastleEnemy(1, 'CASTLE');
            setView('BATTLE');
        };

        const startTrain = () => {
            setBattleMode('TRAIN');
            setCastleFloor(1);
            setBattleStats({}); 
            setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));
            generateCastleEnemy(1, 'TRAIN');
            setView('BATTLE');
        }

        const startDistrict = () => {
            setBattleMode('DISTRICT');
            setBattleStats({});
            setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));
            
            const baseHp = 5000 * (player.stage * 0.5);
            const newEnemy = {
                id: 'DISTRICT_BOSS',
                name: '상현 6 다키 (폭주)',
                maxHp: Math.floor(baseHp),
                currentHp: Math.floor(baseHp),
                atk: 200 + (player.stage * 10),
                rewardGold: 10000,
                isBoss: true,
                imageColor: 'text-pink-600',
                skillProb: 0.4,
                skillName: '오비 참격',
                skillDmgMult: 2.0
            };
            setEnemy(newEnemy);
            setBattleLog(['유곽 잠입 성공! 맹독 주의보!']);
            setView('BATTLE');
        }

        const startDefense = () => {
            setBattleMode('DEFENSE');
            setBattleStats({});
            setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));
            setDollMaxHp(10000 + (player.stage * 500));
            setDollHp(10000 + (player.stage * 500));
            
            const baseHp = 3000 * (player.stage * 0.3);
            const newEnemy = {
                id: 'DEFENSE_BOSS',
                name: '상현 4 한텐구 (분신)',
                maxHp: Math.floor(baseHp),
                currentHp: Math.floor(baseHp),
                atk: 150 + (player.stage * 5),
                rewardGold: 5000,
                isBoss: true,
                imageColor: 'text-yellow-700',
                skillProb: 0.3,
                skillName: '목룡',
                skillDmgMult: 1.5
            };
            setEnemy(newEnemy);
            setBattleLog(['도공 마을 방어 시작! 인형을 지키세요!']);
            setView('BATTLE');
        }

        const generateCastleEnemy = (floor, type) => {
            const baseHp = 100 * Math.pow(1.15, floor); 
            const baseAtk = 20 * Math.pow(1.1, floor);
            const reward = 50 * Math.pow(1.1, floor);
            
            const isBoss = floor % 10 === 0;
            const name = type === 'CASTLE' 
                ? (isBoss ? `무한성 십이귀월 (층주)` : `무한성 혈귀 (잡몹)`)
                : (isBoss ? `무한열차 엔무 (융합)` : `무한열차 하급 혈귀`);
            
            const newEnemy = {
                id: Math.random().toString(),
                name: `${name}`,
                maxHp: Math.floor(baseHp),
                currentHp: Math.floor(baseHp),
                atk: Math.floor(baseAtk),
                rewardGold: Math.floor(reward),
                isBoss: isBoss,
                imageColor: isBoss ? 'text-purple-500' : 'text-slate-500',
                skillProb: isBoss ? 0.3 : 0,
                skillName: isBoss ? '혈귀술' : null,
                skillDmgMult: 2.5
            };
            setEnemy(newEnemy);
            setBattleLog([`${type === 'CASTLE' ? '무한성' : '열차'} ${floor}${type === 'CASTLE' ? '층' : '칸'} - 적 출현!`]);
        };

        const startRaid = () => {
            setBattleMode('RAID');
            setRaidScore(0);
            setBattleStats({});
            setPlayer(p => ({...p, ownedSlayers: resetCooldowns(p.ownedSlayers)}));

            const newEnemy = {
                id: 'MUZAN_FINAL',
                name: '키부츠지 무잔 (최종)',
                maxHp: 999999999, 
                currentHp: 999999999,
                atk: 5000 + (player.stage * 100), 
                rewardGold: 0, 
                isBoss: true,
                imageColor: 'text-red-700',
                skillProb: 0.3,
                skillName: '촉수 난무',
                skillDmgMult: 3.0
            };
            setEnemy(newEnemy);
            setBattleLog([`최종 국면 시작! 무잔을 저지하십시오!`]);
            setView('BATTLE');
        };

        const calculateDamage = (slayer, damageMultiplier) => {
          const synergies = getSynergies(player.selectedSlayerIds);
          let baseAtk = slayer.atk;
          
          let multiplier = 1.0;
          synergies.forEach(s => {
             const mod = s.apply(slayer.id, { atk: 100, maxHp: 100 }); 
             if (mod.atk !== 100) multiplier *= (mod.atk / 100);
          });

          multiplier += (player.trainingLevels?.swing || 0) * 0.03;

          const weaponLv = slayer.weaponLevel || 0;
          let critRate = 0.05 + (weaponLv * 0.01) + ((player.trainingLevels?.meditation || 0) * 0.01);
          let critDmgMult = 1.5 + (weaponLv * 0.05);

          const artifact = player.inventory.find(i => i.id === slayer.equippedArtifactId);
          if (artifact) {
              if (artifact.type === 'stat_boost' && artifact.stat === 'atk') multiplier += artifact.val;
              if (artifact.type === 'crit_rate') critRate += artifact.val;
              if (artifact.type === 'crit_dmg') critDmgMult += artifact.val;
          }

          const masteryBonus = 1 + ((slayer.mastery || 0) * 0.001);
          const totalAtk = baseAtk * multiplier * masteryBonus;
          
          const isHeal = slayer.role === Role.SUPPORTER;
          const finalAmt = totalAtk * damageMultiplier; 
          
          const isCrit = Math.random() < critRate;
          const finalResult = Math.floor(isCrit ? finalAmt * critDmgMult : finalAmt);

          let leechAmount = 0;
           if (!isHeal && artifact && artifact.type === 'leech') {
              leechAmount = Math.floor(finalResult * artifact.val);
          }

          return { finalDmg: finalResult, isCrit, leechAmount, isHeal };
        };

        const onUseSkillLogic = (slayerId, isAwaken) => {
            if (!enemy || enemy.currentHp <= 0 && battleMode !== 'RAID') return;
            
            setPlayer(prev => {
                const s = prev.ownedSlayers.find(s => s.id === slayerId);
                if (!s) return prev;
                
                const skill = isAwaken ? s.awakenSkill : s.skill;
                const cooldownReducePercent = ((prev.inventory.find(i=>i.id===s.equippedArtifactId)?.type === 'cooldown' ? prev.inventory.find(i=>i.id===s.equippedArtifactId).val : 0) + (player.trainingLevels?.reflex || 0) * 0.01);
                const cooldown = Math.max(1, skill.cooldown * (1 - cooldownReducePercent));

                // Mastery increase
                s.mastery = (s.mastery || 0) + 1;
                
                const skillLevel = isAwaken ? (s.awakenSkillLevel || 1) : (s.skillLevel || 1);
                // Simple scalar for skill levels: +10% per level base, +20% for awaken
                const levelBonus = isAwaken ? (skillLevel - 1) * 0.2 : (skillLevel - 1) * 0.1;
                
                const { finalDmg, isCrit, leechAmount, isHeal } = calculateDamage(s, skill.damageMultiplier + levelBonus);

                // --- Supporter Logic ---
                if (isHeal) {
                     // Heal logic
                     const partyIds = prev.selectedSlayerIds;
                     // Find lowest HP %
                     let target = null;
                     let minPct = 101;
                     
                     const newSlayers = prev.ownedSlayers.map(sl => {
                         if(partyIds.includes(sl.id) && sl.currentHp > 0 && sl.currentHp < sl.maxHp) {
                             const pct = (sl.currentHp / sl.maxHp) * 100;
                             if(pct < minPct) { minPct = pct; target = sl.id; }
                         }
                         return sl;
                     });

                     if(target || skill.damageMultiplier === 0) { // 0 mult means Global heal usually
                         const isGlobal = skill.damageMultiplier === 0;
                         const healAmt = finalDmg;
                         
                         const healedSlayers = prev.ownedSlayers.map(sl => {
                             if(partyIds.includes(sl.id) && (isGlobal || sl.id === target)) {
                                 return { ...sl, currentHp: Math.min(sl.maxHp, sl.currentHp + healAmt) };
                             }
                             if(sl.id === s.id) {
                                 return { ...sl, [isAwaken ? 'awakenSkillReadyAt' : 'skillReadyAt']: Date.now() + (cooldown * 1000) };
                             }
                             return sl;
                         });
                         addLog(`${s.name}의 ${skill.name}! 아군 ${isGlobal ? '전체' : ''} ${healAmt.toLocaleString()} 회복!`);
                         return { ...prev, ownedSlayers: healedSlayers };
                     } else {
                         // No one to heal, just set CD
                          const cdSlayers = prev.ownedSlayers.map(sl => sl.id === s.id ? { ...sl, [isAwaken ? 'awakenSkillReadyAt' : 'skillReadyAt']: Date.now() + (cooldown * 1000) } : sl);
                          addLog(`${s.name}의 ${skill.name}! (치료 대상 없음)`);
                          return { ...prev, ownedSlayers: cdSlayers };
                     }

                } else {
                    // Attacker Logic
                    setEnemy(e => e ? { ...e, currentHp: Math.max(0, e.currentHp - finalDmg) } : null);
                    if (battleMode === 'RAID') setRaidScore(rs => rs + finalDmg);
                    
                    setBattleStats(bs => ({
                        ...bs,
                        [slayerId]: (bs[slayerId] || 0) + finalDmg
                    }));
                    
                    addLog(`${s.name}의 ${skill.name}! ${finalDmg.toLocaleString()} 피해! ${isCrit ? '(치명타!)' : ''}`);

                    const newSlayers = prev.ownedSlayers.map(sl => {
                        if (sl.id === slayerId) {
                            const newHp = leechAmount > 0 ? Math.min(sl.maxHp, sl.currentHp + leechAmount) : sl.currentHp;
                            return {
                                ...sl,
                                currentHp: newHp,
                                [isAwaken ? 'awakenSkillReadyAt' : 'skillReadyAt']: Date.now() + (cooldown * 1000)
                            };
                        }
                        return sl;
                    });
                    
                    return { ...prev, ownedSlayers: newSlayers };
                }
            });
        };

        const useSkill = (id) => onUseSkillLogic(id, false);
        const useAwakenSkill = (id) => onUseSkillLogic(id, true);

        const upgradeSlayer = (slayerId) => {
          setPlayer(prev => {
            const slayer = prev.ownedSlayers.find(s => s.id === slayerId);
            if (!slayer) return prev;
            
            const cost = Math.floor(100 * Math.pow(1.2, slayer.level));
            if (prev.gold < cost) {
                alert('골드가 부족합니다.');
                return prev;
            }
            
            const limit = 100 + (slayer.limitBreakLevel || 0) * 50;
            if (slayer.level >= limit) {
                alert('최대 레벨입니다. 초월이 필요합니다.');
                return prev;
            }

            const nextLevel = slayer.level + 1;
            
            // Rank Multiplier
            const rankMult = RANKS[slayer.rankIdx || 0].multiplier;
            const awakeningMult = (slayer.markLevel || 0) > 0 ? (1 + (slayer.markLevel * 0.5)) : 1;

            const baseMaxHp = Math.floor(slayer.baseHp * (1 + nextLevel * 0.2) * rankMult * awakeningMult);
            const baseAtk = Math.floor(slayer.baseAtk * (1 + nextLevel * 0.15) * rankMult * awakeningMult);

            return {
              ...prev,
              gold: prev.gold - cost,
              ownedSlayers: prev.ownedSlayers.map(s => {
                if (s.id === slayerId) {
                  return { ...s, level: nextLevel, maxHp: baseMaxHp, atk: baseAtk, currentHp: baseMaxHp };
                }
                return s;
              })
            };
          });
        };

        const promoteSlayer = (slayerId) => {
            setPlayer(prev => {
                const slayer = prev.ownedSlayers.find(s => s.id === slayerId);
                const currentIdx = slayer.rankIdx || 0;
                const nextRank = RANKS[currentIdx + 1];
                
                if (!nextRank || slayer.level < nextRank.minLv || prev.gold < nextRank.cost) return prev;

                return {
                    ...prev,
                    gold: prev.gold - nextRank.cost,
                    ownedSlayers: prev.ownedSlayers.map(s => {
                        if (s.id === slayerId) {
                            const newIdx = currentIdx + 1;
                            const rankMult = RANKS[newIdx].multiplier;
                            const awakeningMult = (s.markLevel || 0) > 0 ? (1 + (s.markLevel * 0.5)) : 1;
                            const baseMaxHp = Math.floor(s.baseHp * (1 + s.level * 0.2) * rankMult * awakeningMult);
                            const baseAtk = Math.floor(s.baseAtk * (1 + s.level * 0.15) * rankMult * awakeningMult);
                            return { ...s, rankIdx: newIdx, maxHp: baseMaxHp, atk: baseAtk, currentHp: baseMaxHp };
                        }
                        return s;
                    })
                }
            })
        }

        const awakenMark = (slayerId) => {
            setPlayer(prev => {
                const s = prev.ownedSlayers.find(sl => sl.id === slayerId);
                if(s.level < 50 || prev.gold < 100000 || prev.ironSand < 100) return prev;
                
                const newMarkLevel = (s.markLevel || 0) + 1;
                
                // Reset level to 1, keep rank
                // Apply Mark Multiplier
                const rankMult = RANKS[s.rankIdx || 0].multiplier;
                const awakeningMult = 1 + (newMarkLevel * 0.5);
                
                const baseMaxHp = Math.floor(s.baseHp * (1 + 1 * 0.2) * rankMult * awakeningMult);
                const baseAtk = Math.floor(s.baseAtk * (1 + 1 * 0.15) * rankMult * awakeningMult);

                return {
                    ...prev,
                    gold: prev.gold - 100000,
                    ironSand: prev.ironSand - 100,
                    ownedSlayers: prev.ownedSlayers.map(sl => {
                        if(sl.id === slayerId) {
                            return { ...sl, level: 1, markLevel: newMarkLevel, maxHp: baseMaxHp, atk: baseAtk, currentHp: baseMaxHp };
                        }
                        return sl;
                    })
                };
            });
        }
        
        const limitBreakSlayer = (slayerId) => {
            setPlayer(prev => {
                const s = prev.ownedSlayers.find(sl => sl.id === slayerId);
                const currentLB = s.limitBreakLevel || 0;
                if(currentLB >= 5) return prev;

                const cost = { gold: 1000000 * (currentLB + 1), lily: 10 * (currentLB + 1), iron: 500 * (currentLB + 1) };
                if (prev.gold < cost.gold || prev.blueLily < cost.lily || prev.ironSand < cost.iron) return prev;

                return {
                    ...prev,
                    gold: prev.gold - cost.gold,
                    blueLily: prev.blueLily - cost.lily,
                    ironSand: prev.ironSand - cost.iron,
                    ownedSlayers: prev.ownedSlayers.map(sl => {
                        if (sl.id === slayerId) {
                            return { ...sl, limitBreakLevel: currentLB + 1 };
                        }
                        return sl;
                    })
                }
            });
        }

        const refineWeapon = (slayerId) => {
            setPlayer(prev => {
                const s = prev.ownedSlayers.find(sl => sl.id === slayerId);
                const lv = s.weaponLevel || 0;
                const ironCost = 10 + (lv * 5);
                const goldCost = 1000 + (lv * 500);

                if (prev.ironSand < ironCost || prev.gold < goldCost) return prev;

                return {
                    ...prev,
                    ironSand: prev.ironSand - ironCost,
                    gold: prev.gold - goldCost,
                    ownedSlayers: prev.ownedSlayers.map(sl => {
                        if(sl.id === slayerId) return { ...sl, weaponLevel: lv + 1 };
                        return sl;
                    })
                }
            })
        }

        const trainHashira = (typeId) => {
            setPlayer(prev => {
                 const currentLv = prev.trainingLevels?.[typeId] || 0;
                 const type = TRAINING_TYPES.find(t => t.id === typeId);
                 const cost = Math.floor(type.costBase * Math.pow(type.costScale, currentLv));

                 if (prev.gold < cost) return prev;
                 
                 const newLevels = { ...prev.trainingLevels, [typeId]: currentLv + 1 };
                 
                 const updatedSlayers = prev.ownedSlayers.map(s => {
                      if (type.stat === 'atk' || type.stat === 'maxHp') {
                           if (type.stat === 'maxHp') {
                               return { ...s, maxHp: Math.floor(s.maxHp * 1.05), currentHp: Math.floor(s.currentHp * 1.05) };
                           }
                           if (type.stat === 'atk') {
                               return { ...s, atk: Math.floor(s.atk * 1.03) };
                           }
                      }
                      return s;
                 });

                 return {
                     ...prev,
                     gold: prev.gold - cost,
                     trainingLevels: newLevels,
                     ownedSlayers: updatedSlayers
                 };
            })
        }

        const recruitSlayer = (id) => {
             const template = SLAYERS_DATA.find(s => s.id === id);
             if (!template) return;
             
             const price = template.currency === 'LILY' ? template.lilyPrice : template.price;
             const currency = template.currency === 'LILY' ? 'blueLily' : 'gold';
             
             if (player[currency] < price) return;
             if (player.ownedSlayers.some(s => s.id === id)) return;
             
             setPlayer(prev => ({
                 ...prev,
                 [currency]: prev[currency] - price,
                 ownedSlayers: [...prev.ownedSlayers, {
                     ...template,
                     level: 1, rankIdx: 0, weaponLevel: 0, markLevel: 0, limitBreakLevel: 0, mastery: 0,
                     currentHp: template.baseHp, maxHp: template.baseHp, atk: template.baseAtk,
                     skillReadyAt: 0, awakenSkillReadyAt: 0, equippedArtifactId: null,
                     skillLevel: 1, awakenSkillLevel: 1
                 }]
             }));
        }

        const healAll = () => {
            setPlayer(prev => ({
                ...prev,
                ownedSlayers: prev.ownedSlayers.map(s => ({ ...s, currentHp: s.maxHp }))
            }));
        };

        const buyShopItem = (type, cost) => {
             if (type === 'LEGENDARY_BOX') {
                 if(player.blueLily < cost) return;
                 // Gacha Logic
                 const rand = Math.random();
                 let rarity = 'RARE';
                 if (rand < 0.2) rarity = 'LEGENDARY';
                 else if (rand < 0.6) rarity = 'EPIC';
                 
                 const pool = ARTIFACT_TEMPLATES.filter(a => a.rarity === rarity);
                 const item = pool[Math.floor(Math.random() * pool.length)];
                 const newItem = { ...item, id: Math.random().toString() }; // Unique Instance
                 
                 setPlayer(prev => ({
                     ...prev,
                     blueLily: prev.blueLily - cost,
                     inventory: [...prev.inventory, newItem]
                 }));
                 alert(`[${item.rarity}] ${item.name} 획득!`);
             }
             else if (type === 'ARTIFACT_GACHA_GOLD') {
                 // Gold Gacha: mostly common/rare
                 if (player.gold < cost) return;
                 const rand = Math.random();
                 let rarity = 'COMMON';
                 if (rand < 0.01) rarity = 'LEGENDARY'; // 1%
                 else if (rand < 0.1) rarity = 'EPIC'; // 9%
                 else if (rand < 0.4) rarity = 'RARE'; // 30%
                 // else Common 60%

                 const pool = ARTIFACT_TEMPLATES.filter(a => a.rarity === rarity);
                 const item = pool[Math.floor(Math.random() * pool.length)];
                 const newItem = { ...item, id: Math.random().toString() };
                 
                 setPlayer(prev => ({
                     ...prev,
                     gold: prev.gold - cost,
                     inventory: [...prev.inventory, newItem]
                 }));
                 alert(`[${item.rarity}] ${item.name} 획득!`);
             }
             else if (type === 'IRON_BUNDLE') {
                 if(player.blueLily < cost) return;
                 setPlayer(prev => ({ ...prev, blueLily: prev.blueLily - cost, ironSand: prev.ironSand + 500 }));
                 alert('성성철 500개 획득!');
             }
             else if (type === 'GOLD_BUNDLE') {
                 if(player.blueLily < cost) return;
                 setPlayer(prev => ({ ...prev, blueLily: prev.blueLily - cost, gold: prev.gold + 1000000 }));
                 alert('1,000,000 골드 획득!');
             }
        }

        const equipArtifact = (slayerId, artifactId) => {
             setPlayer(prev => {
                 // Check if artifact is equipped by someone else
                 const other = prev.ownedSlayers.find(s => s.equippedArtifactId === artifactId);
                 
                 const newSlayers = prev.ownedSlayers.map(s => {
                     // Unequip from other
                     if (other && s.id === other.id) return { ...s, equippedArtifactId: null };
                     // Equip to target
                     if (s.id === slayerId) return { ...s, equippedArtifactId: artifactId };
                     return s;
                 });
                 return { ...prev, ownedSlayers: newSlayers };
             });
        }

        const unequipArtifact = (slayerId) => {
            setPlayer(prev => ({
                ...prev,
                ownedSlayers: prev.ownedSlayers.map(s => s.id === slayerId ? { ...s, equippedArtifactId: null } : s)
            }));
        }

        const upgradeSkill = (slayerId, type) => {
            setPlayer(prev => {
                const s = prev.ownedSlayers.find(sl => sl.id === slayerId);
                const skillLv = type === 'BASIC' ? (s.skillLevel || 1) : (s.awakenSkillLevel || 1);
                
                const goldCost = (type === 'BASIC' ? 5000 : 10000) * skillLv;
                const ironCost = (type === 'BASIC' ? 50 : 100) * skillLv;

                if (prev.gold < goldCost || prev.ironSand < ironCost) return prev;

                return {
                    ...prev,
                    gold: prev.gold - goldCost,
                    ironSand: prev.ironSand - ironCost,
                    ownedSlayers: prev.ownedSlayers.map(sl => {
                        if(sl.id === slayerId) {
                            if (type === 'BASIC') return { ...sl, skillLevel: skillLv + 1 };
                            else return { ...sl, awakenSkillLevel: skillLv + 1 };
                        }
                        return sl;
                    })
                }
            });
        }

        // Battle Loop
        useEffect(() => {
          if (view !== 'BATTLE' || !enemy) {
            if (battleIntervalRef.current) clearInterval(battleIntervalRef.current);
            return;
          }

          battleIntervalRef.current = window.setInterval(() => {
            // 1. Check Win
            if (enemy.currentHp <= 0 && battleMode !== 'RAID') {
               // Check if boss
               const isBoss = enemy.isBoss;
               let lilyDrop = 0;
               if (isBoss) {
                   // Boss drops lilies. Increased drop rate and amount
                   lilyDrop = Math.max(1, Math.floor(player.stage / 3)) + 2;
               }

               addLog(`토벌 완료! ${enemy.rewardGold.toLocaleString()}G ${lilyDrop > 0 ? `, 피안화 ${lilyDrop}개` : ''} 획득`);
               
               // Chance to drop Artifact
               if (Math.random() < 0.05) { // 5% chance
                   const pool = ARTIFACT_TEMPLATES;
                   const drop = pool[Math.floor(Math.random() * pool.length)];
                   const newItem = { ...drop, id: Math.random().toString() };
                   setPlayer(p => ({ ...p, inventory: [...p.inventory, newItem] }));
                   addLog(`[전리품] ${drop.name} 획득!`);
               }
               // Chance to drop Iron Sand
               if (Math.random() < 0.3) {
                   const ironAmt = 10 + Math.floor(player.stage * 2);
                   setPlayer(p => ({ ...p, ironSand: p.ironSand + ironAmt }));
                   addLog(`[전리품] 성성철 ${ironAmt}개 획득`);
               }

               setTimeout(() => {
                 setPlayer(p => ({ 
                     ...p, 
                     gold: p.gold + enemy.rewardGold,
                     blueLily: p.blueLily + lilyDrop,
                     stage: (battleMode === 'NORMAL' || battleMode === 'DISTRICT') ? p.stage + 1 : p.stage,
                     infinityCastleRecord: battleMode === 'CASTLE' ? Math.max(p.infinityCastleRecord, castleFloor) : p.infinityCastleRecord
                 }));

                 if (battleMode === 'CASTLE' || battleMode === 'TRAIN') {
                     setCastleFloor(f => f + 1);
                     generateCastleEnemy(castleFloor + 1, battleMode);
                 } else {
                     setEnemy(null);
                     setView('ESTATE');
                 }
               }, 1500);
               return;
            }

            // 2. Check Loss (All slayers dead) or Defense Fail
            const partyIds = player.selectedSlayerIds;
            const partyMembers = player.ownedSlayers.filter(s => partyIds.includes(s.id));
            const aliveSlayers = partyMembers.filter(s => s.currentHp > 0);
            
            if (aliveSlayers.length === 0 || (battleMode === 'DEFENSE' && dollHp <= 0)) {
              if (battleMode === 'RAID') {
                  finishRaid();
                  return;
              }
              const consolationGold = Math.floor(enemy.rewardGold * 0.1);
              addLog(`패배... 은(는)폐부대가 ${consolationGold}G를 수습했습니다.`);
              setTimeout(() => {
                setPlayer(p => ({ ...p, gold: p.gold + consolationGold }));
                setEnemy(null);
                setView('ESTATE');
              }, 2500);
              return;
            }

            // 3. Combat Round
            
            // Special Mode Mechanics
            if (battleMode === 'DISTRICT') {
                // Poison Dmg every turn
                setPlayer(prev => ({
                    ...prev,
                    ownedSlayers: prev.ownedSlayers.map(s => {
                        if (partyIds.includes(s.id) && s.currentHp > 0) {
                            return { ...s, currentHp: Math.max(0, s.currentHp - Math.floor(s.maxHp * 0.05)) };
                        }
                        return s;
                    })
                }));
            }

            // Enemy Attack
            const targetDoll = battleMode === 'DEFENSE' && Math.random() < 0.5;
            
            if (targetDoll) {
                const dmg = Math.max(10, enemy.atk);
                setDollHp(h => Math.max(0, h - dmg));
                addLog(`적이 인형을 공격! (내구도: ${dollHp - dmg})`);
            } else {
                const target = aliveSlayers[Math.floor(Math.random() * aliveSlayers.length)];
                setPlayer(prev => ({
                    ...prev,
                    ownedSlayers: prev.ownedSlayers.map(s => {
                         if (target && s.id === target.id) {
                           const dmg = Math.max(1, enemy.atk - Math.floor(s.level * 2)); 
                           return { ...s, currentHp: Math.max(0, s.currentHp - dmg) };
                         }
                         return s;
                    })
                }));
            }
            
            // Enemy Skill (Boss only)
            if (enemy.isBoss && enemy.skillName && Math.random() < (enemy.skillProb || 0.2)) {
                 const dmg = Math.floor(enemy.atk * (enemy.skillDmgMult || 1.5));
                 addLog(`${enemy.name}의 ${enemy.skillName}! 강력한 피해!`);
                 setPlayer(prev => ({
                    ...prev,
                    ownedSlayers: prev.ownedSlayers.map(s => {
                         if (partyIds.includes(s.id) && s.currentHp > 0) {
                             return { ...s, currentHp: Math.max(0, s.currentHp - dmg) };
                         }
                         return s;
                    })
                 }));
            }

            // Auto Attack (20% ATK)
            let totalPlayerDmg = 0;
            aliveSlayers.forEach(s => {
               const { finalDmg } = calculateDamage(s, 0.2);
               totalPlayerDmg += finalDmg;
            });

            setEnemy(prev => {
              if (!prev) return null;
              const newHp = Math.max(0, prev.currentHp - totalPlayerDmg);
              return { ...prev, currentHp: newHp };
            });
            
            if (battleMode === 'RAID') {
                setRaidScore(s => s + totalPlayerDmg);
            }

          }, 1200);

          return () => {
            if (battleIntervalRef.current) clearInterval(battleIntervalRef.current);
          };
        }, [view, enemy, player.ownedSlayers, player.selectedSlayerIds, dollHp, battleMode]);


        if (view === 'MANAGEMENT') {
            return (
                <ManagementView 
                    player={player}
                    onBack={() => setView('ESTATE')}
                    onUpgrade={upgradeSlayer}
                    onPromote={promoteSlayer}
                    onAwakenMark={awakenMark}
                    onLimitBreak={limitBreakSlayer}
                    onRefineWeapon={refineWeapon}
                    onEquipArtifact={equipArtifact}
                    onUnequipArtifact={unequipArtifact}
                    onToggleSlayer={toggleSlayerSelection}
                    onUpgradeSkill={upgradeSkill}
                />
            )
        }

        if (view === 'RECRUIT') {
            return (
              <RecruitView 
                player={player}
                onBuy={recruitSlayer}
                onBack={() => setView('ESTATE')}
              />
            );
        }

        if (view === 'BATTLE' && enemy) {
            return (
              <BattleView 
                player={player}
                enemy={enemy}
                mode={battleMode}
                floor={castleFloor}
                raidScore={raidScore}
                dollHp={dollHp}
                dollMaxHp={dollMaxHp}
                onSkillUse={useSkill}
                onAwakenSkillUse={useAwakenSkill}
                onRetreat={() => {
                   if(battleMode === 'RAID') finishRaid();
                   else {
                       setEnemy(null);
                       setView('ESTATE');
                   }
                }}
                battleLog={battleLog}
                battleStats={battleStats}
              />
            );
        }

        return (
            <EstateView 
              player={player}
              onStartPatrol={startPatrol}
              onStartInfinityCastle={startInfinityCastle}
              onStartRaid={startRaid}
              onStartDefense={startDefense}
              onStartTrain={startTrain}
              onStartDistrict={startDistrict}
              onHealAll={healAll}
              onRecruit={() => setView('RECRUIT')}
              onToggleSlayer={toggleSlayerSelection}
              onChangeDifficulty={changeDifficulty}
              onResetData={resetGameData}
              onBuyShopItem={buyShopItem}
              onOpenManagement={() => setView('MANAGEMENT')}
              onTrain={trainHashira}
            />
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
